<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Latest Posts &#8211; Life is a Struggle</title>
<meta name="description" content="Describe this nonsense.">
<meta name="keywords" content="Jekyll, theme, themes, responsive, blog, modern">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Latest Posts">
<meta property="og:description" content="Describe this nonsense.">
<meta property="og:url" content="/index.html">
<meta property="og:site_name" content="Life is a Struggle">





<link rel="canonical" href="/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Life is a Struggle Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="/images/avatar.png" alt="陆 伟 photo" class="author-photo">
					<h4>陆 伟</h4>
					<p>心有猛虎，细嗅蔷薇.</p>
				</li>
				<li><a href="/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:1071932819@qq.com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				
				
				
				
				<li>
					<a href="http://github.com//luwei2012"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="/posts/">All Posts</a></li>
				<li><a href="/tags/">All Tags</a></li>
			</ul>
		</li>
		
	    
	        
	        
	    <li><a href="https://bitbucket.org/luoqiaowei" target="_blank">Bitbucket</a></li>
	  
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


<div class="entry-header">
  
  
    <div class="entry-image">
      <img src="/images/abstract-1.jpg" alt="Latest Posts">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>Life is a Struggle</h1>
      <h2>Latest Posts</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->

<div id="main" role="main">
  
<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-11-07T18:42:17+08:00"><a href="/ios/ios-udp-client/">November 07, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About 陆 伟">陆 伟</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
        Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/ios/ios-udp-client/" rel="bookmark" title="ios-UDP-Client" itemprop="url">ios-UDP-Client</a></h1>
    
  </header>
  <div class="entry-content">
    

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-11-07T18:41:39+08:00"><a href="/android/viewpage/">November 07, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About 陆 伟">陆 伟</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
        Reading time ~24 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/android/viewpage/" rel="bookmark" title="ViewPage源代码学习(上)" itemprop="url">ViewPage源代码学习(上)</a></h1>
    
  </header>
  <div class="entry-content">
    <p>搞android开发的不可能没用过ViewPage，这个功能强大的控件是android独有的（IOS上没有这样的玩意儿，除了一些第三方的库）。一直都想研究ViewPage的源码，自己又很懒，在百度上搜了搜，
硬是没有一家写过这个，无奈，只能自己上来啃了。ViewPage继承自ViewGroup，所以我们在看ViewPage的代码的时候还是按照ViewGroup的功能逻辑来看。</p>

<p>首先自然是构造函数，没啥东西：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">void</span> <span class="nf">initViewPager</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">setWillNotDraw</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="n">setDescendantFocusability</span><span class="o">(</span><span class="n">FOCUS_AFTER_DESCENDANTS</span><span class="o">);</span>
        <span class="n">setFocusable</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">Context</span> <span class="n">context</span> <span class="o">=</span> <span class="n">getContext</span><span class="o">();</span>
        <span class="n">mScroller</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Scroller</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">sInterpolator</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">ViewConfiguration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="n">ViewConfiguration</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">float</span> <span class="n">density</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span><span class="na">getDisplayMetrics</span><span class="o">().</span><span class="na">density</span><span class="o">;</span>

        <span class="n">mTouchSlop</span> <span class="o">=</span> <span class="n">ViewConfigurationCompat</span><span class="o">.</span><span class="na">getScaledPagingTouchSlop</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
        <span class="n">mMinimumVelocity</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">MIN_FLING_VELOCITY</span> <span class="o">*</span> <span class="n">density</span><span class="o">);</span>
        <span class="n">mMaximumVelocity</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getScaledMaximumFlingVelocity</span><span class="o">();</span>
        <span class="n">mLeftEdge</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">EdgeEffectCompat</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="n">mRightEdge</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">EdgeEffectCompat</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>

        <span class="n">mFlingDistance</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">MIN_DISTANCE_FOR_FLING</span> <span class="o">*</span> <span class="n">density</span><span class="o">);</span>
        <span class="n">mCloseEnough</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">CLOSE_ENOUGH</span> <span class="o">*</span> <span class="n">density</span><span class="o">);</span>
        <span class="n">mDefaultGutterSize</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">DEFAULT_GUTTER_SIZE</span> <span class="o">*</span> <span class="n">density</span><span class="o">);</span>

        <span class="n">ViewCompat</span><span class="o">.</span><span class="na">setAccessibilityDelegate</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">new</span> <span class="nf">MyAccessibilityDelegate</span><span class="o">());</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">ViewCompat</span><span class="o">.</span><span class="na">getImportantForAccessibility</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
                <span class="o">==</span> <span class="n">ViewCompat</span><span class="o">.</span><span class="na">IMPORTANT_FOR_ACCESSIBILITY_AUTO</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ViewCompat</span><span class="o">.</span><span class="na">setImportantForAccessibility</span><span class="o">(</span><span class="k">this</span><span class="o">,</span>
                    <span class="n">ViewCompat</span><span class="o">.</span><span class="na">IMPORTANT_FOR_ACCESSIBILITY_YES</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></div>

<p>第一句话意思根据android官方注释：如果这个view自己没有做任何的draw就设置这个为true，可以优化性能。默认为false，也就是需要调用onDraw方法。如果你覆写的onDraw，则必须清除(也就是false)这个标志。</p>

<p>第二句话设置焦点获取规则，这个就不详细说了，默认规则就是儿子都不要老子才要。</p>

<p>接下来创建了一个Scroller，用来处理滚动事件，这个需要先储备一下Scroller的用法和作用。</p>

<p>再接着感觉比较重要的就是ViewCompat.setAccessibilityDelegate(this, new MyAccessibilityDelegate());，这个具体作用现在还不清除，后面再看。
其他的就是一些变量的初始化，我们进入下一步。在进入下一步之前我们需要知道ViewPage下一步是做什么？</p>

<p>一般来说一个activity或者fragment使用ViewPage，都是在XML文件或者new出来之后添加到父View中，接着就是设置Adapter和监听器，甚至可以设置初始页面的索引。最后在View将要绘制的时候才进入View的绘制消息传递(包含measure和layout传递等)。
所以ViewPage第二个触发的应该是跟Adapter有关的函数。</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**</span>
<span class="cm">     * Set a PagerAdapter that will supply views for this pager as needed.</span>
<span class="cm">     *</span>
<span class="cm">     * @param adapter Adapter to use</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAdapter</span><span class="o">(</span><span class="n">PagerAdapter</span> <span class="n">adapter</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mAdapter</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mAdapter</span><span class="o">.</span><span class="na">unregisterDataSetObserver</span><span class="o">(</span><span class="n">mObserver</span><span class="o">);</span>
            <span class="n">mAdapter</span><span class="o">.</span><span class="na">startUpdate</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mItems</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="n">ItemInfo</span> <span class="n">ii</span> <span class="o">=</span> <span class="n">mItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="n">mAdapter</span><span class="o">.</span><span class="na">destroyItem</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">ii</span><span class="o">.</span><span class="na">position</span><span class="o">,</span> <span class="n">ii</span><span class="o">.</span><span class="na">object</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">mAdapter</span><span class="o">.</span><span class="na">finishUpdate</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="n">mItems</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="n">removeNonDecorViews</span><span class="o">();</span>
            <span class="n">mCurItem</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">scrollTo</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="n">PagerAdapter</span> <span class="n">oldAdapter</span> <span class="o">=</span> <span class="n">mAdapter</span><span class="o">;</span>
        <span class="n">mAdapter</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">;</span>
        <span class="n">mExpectedAdapterCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">mAdapter</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mObserver</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mObserver</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">PagerObserver</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">mAdapter</span><span class="o">.</span><span class="na">registerDataSetObserver</span><span class="o">(</span><span class="n">mObserver</span><span class="o">);</span>
            <span class="n">mPopulatePending</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">wasFirstLayout</span> <span class="o">=</span> <span class="n">mFirstLayout</span><span class="o">;</span>
            <span class="n">mFirstLayout</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">mExpectedAdapterCount</span> <span class="o">=</span> <span class="n">mAdapter</span><span class="o">.</span><span class="na">getCount</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mRestoredCurItem</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mAdapter</span><span class="o">.</span><span class="na">restoreState</span><span class="o">(</span><span class="n">mRestoredAdapterState</span><span class="o">,</span> <span class="n">mRestoredClassLoader</span><span class="o">);</span>
                <span class="n">setCurrentItemInternal</span><span class="o">(</span><span class="n">mRestoredCurItem</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                <span class="n">mRestoredCurItem</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                <span class="n">mRestoredAdapterState</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">mRestoredClassLoader</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="n">wasFirstLayout</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">populate</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">requestLayout</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">mAdapterChangeListener</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">oldAdapter</span> <span class="o">!=</span> <span class="n">adapter</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mAdapterChangeListener</span><span class="o">.</span><span class="na">onAdapterChanged</span><span class="o">(</span><span class="n">oldAdapter</span><span class="o">,</span> <span class="n">adapter</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></div>

<p>PageAdapter是一个抽象类，常用的一般是FragmentPageAdapter。PageAdapter里面有个DataSetObservable对象，而ViewPage中有个DataSetObserver的实现：PageObserver对象，然后就把这个对象注册到PageAdapter的DataSetObservable对象中去，PageAdapter在调用notifyDataSetChanged的时候就会通知所以观察者调用onChange方法，在ViewPage中实现就是：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">PagerObserver</span> <span class="kd">extends</span> <span class="n">DataSetObserver</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onChanged</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">dataSetChanged</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onInvalidated</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">dataSetChanged</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></div>

<p>前面if里面的一段代码，都是重置状态，startUpdate事实上啥都没做，android官方注释：当已经显示的页面将要有改变产生的时候调用。然而PageAdapter中并没有任何实现，FragmentPageAdapter也是如此。接着一个循环，首次进入必然不会执行。然后是finishUpdate，与startUpdate成对出现，这个在抽象类中没有任何卵用，但是在FragmentPageAdapter覆写了，总结一下就是这个方法里面应该把页面变换的动画立马执行结束。然后是移除所有非Decor的View，也可以忽略，接着默认页面索引为0，滚动到0,0也就是原点位置。
接着才是初始化操作，注册PagerObserver，初始化一些状态变量。需要注意的是mRestoredCurItem里面的逻辑不会走，而是会进入requestLayout();再后面的mAdapterChangeListener这个没怎么用过，直接忽略，根据字面意思和调用时机可以判断是对adapter变化的监听(这里的变化是指adapter对象的变化)。
我们跟着调用逻辑走下去，进入requestLayout();额……具体代码就不看了，反正意思就是要发起一次layout传递。由此也就解释了为何首次设置adapter后不需要调用notifiydatachanged方法。</p>

<p>下面应该就是进入measure方法了。额……没找到，没关系，measure里面会调用onMeasure，这个才是android真正让用户自定义测量的地方。</p>

<p>第一句话自然是setMeasuredDimension(getDefaultSize(0, widthMeasureSpec),getDefaultSize(0, heightMeasureSpec));，获取父亲给自己在measure中计算出的大小，然后就是一系列计算儿子的大小：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/*</span>
<span class="cm">         * Make sure all children have been properly measured. Decor views first.</span>
<span class="cm">         * Right now we cheat and make this less complicated by assuming decor</span>
<span class="cm">         * views won&#39;t intersect. We will pin to edges based on gravity.</span>
<span class="cm">         */</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">getChildCount</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">View</span> <span class="n">child</span> <span class="o">=</span> <span class="n">getChildAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">child</span><span class="o">.</span><span class="na">getVisibility</span><span class="o">()</span> <span class="o">!=</span> <span class="n">GONE</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="n">LayoutParams</span> <span class="n">lp</span> <span class="o">=</span> <span class="o">(</span><span class="n">LayoutParams</span><span class="o">)</span> <span class="n">child</span><span class="o">.</span><span class="na">getLayoutParams</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">lp</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">.</span><span class="na">isDecor</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="kt">int</span> <span class="n">hgrav</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="na">gravity</span> <span class="o">&amp;</span> <span class="n">Gravity</span><span class="o">.</span><span class="na">HORIZONTAL_GRAVITY_MASK</span><span class="o">;</span>
                    <span class="kd">final</span> <span class="kt">int</span> <span class="n">vgrav</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="na">gravity</span> <span class="o">&amp;</span> <span class="n">Gravity</span><span class="o">.</span><span class="na">VERTICAL_GRAVITY_MASK</span><span class="o">;</span>
                    <span class="kt">int</span> <span class="n">widthMode</span> <span class="o">=</span> <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">AT_MOST</span><span class="o">;</span>
                    <span class="kt">int</span> <span class="n">heightMode</span> <span class="o">=</span> <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">AT_MOST</span><span class="o">;</span>
                    <span class="kt">boolean</span> <span class="n">consumeVertical</span> <span class="o">=</span> <span class="n">vgrav</span> <span class="o">==</span> <span class="n">Gravity</span><span class="o">.</span><span class="na">TOP</span> <span class="o">||</span> <span class="n">vgrav</span> <span class="o">==</span> <span class="n">Gravity</span><span class="o">.</span><span class="na">BOTTOM</span><span class="o">;</span>
                    <span class="kt">boolean</span> <span class="n">consumeHorizontal</span> <span class="o">=</span> <span class="n">hgrav</span> <span class="o">==</span> <span class="n">Gravity</span><span class="o">.</span><span class="na">LEFT</span> <span class="o">||</span> <span class="n">hgrav</span> <span class="o">==</span> <span class="n">Gravity</span><span class="o">.</span><span class="na">RIGHT</span><span class="o">;</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">consumeVertical</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">widthMode</span> <span class="o">=</span> <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">EXACTLY</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">consumeHorizontal</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">heightMode</span> <span class="o">=</span> <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">EXACTLY</span><span class="o">;</span>
                    <span class="o">}</span>

                    <span class="kt">int</span> <span class="n">widthSize</span> <span class="o">=</span> <span class="n">childWidthSize</span><span class="o">;</span>
                    <span class="kt">int</span> <span class="n">heightSize</span> <span class="o">=</span> <span class="n">childHeightSize</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">lp</span><span class="o">.</span><span class="na">width</span> <span class="o">!=</span> <span class="n">LayoutParams</span><span class="o">.</span><span class="na">WRAP_CONTENT</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">widthMode</span> <span class="o">=</span> <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">EXACTLY</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">lp</span><span class="o">.</span><span class="na">width</span> <span class="o">!=</span> <span class="n">LayoutParams</span><span class="o">.</span><span class="na">FILL_PARENT</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">widthSize</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="na">width</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">lp</span><span class="o">.</span><span class="na">height</span> <span class="o">!=</span> <span class="n">LayoutParams</span><span class="o">.</span><span class="na">WRAP_CONTENT</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">heightMode</span> <span class="o">=</span> <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">EXACTLY</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">lp</span><span class="o">.</span><span class="na">height</span> <span class="o">!=</span> <span class="n">LayoutParams</span><span class="o">.</span><span class="na">FILL_PARENT</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">heightSize</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="na">height</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="kd">final</span> <span class="kt">int</span> <span class="n">widthSpec</span> <span class="o">=</span> <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">makeMeasureSpec</span><span class="o">(</span><span class="n">widthSize</span><span class="o">,</span> <span class="n">widthMode</span><span class="o">);</span>
                    <span class="kd">final</span> <span class="kt">int</span> <span class="n">heightSpec</span> <span class="o">=</span> <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">makeMeasureSpec</span><span class="o">(</span><span class="n">heightSize</span><span class="o">,</span> <span class="n">heightMode</span><span class="o">);</span>
                    <span class="n">child</span><span class="o">.</span><span class="na">measure</span><span class="o">(</span><span class="n">widthSpec</span><span class="o">,</span> <span class="n">heightSpec</span><span class="o">);</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">consumeVertical</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">childHeightSize</span> <span class="o">-=</span> <span class="n">child</span><span class="o">.</span><span class="na">getMeasuredHeight</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">consumeHorizontal</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">childWidthSize</span> <span class="o">-=</span> <span class="n">child</span><span class="o">.</span><span class="na">getMeasuredWidth</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span></code></pre></div>

<p>看这段代码的逻辑隐约猜测这不是真正的在计算viewpage内容的大小，而是在计算viewpage出去其他控件后可供作为page页面容器的空间大小。因为getChildCount这个时候返回的只是已经添加进viewpage的子view个数，而我们这个时候page页面还没有加进去。先暂时摆在一边，继续看下去：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">mChildWidthMeasureSpec</span> <span class="o">=</span> <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">makeMeasureSpec</span><span class="o">(</span><span class="n">childWidthSize</span><span class="o">,</span> <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">EXACTLY</span><span class="o">);</span>
        <span class="n">mChildHeightMeasureSpec</span> <span class="o">=</span> <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">makeMeasureSpec</span><span class="o">(</span><span class="n">childHeightSize</span><span class="o">,</span> <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">EXACTLY</span><span class="o">);</span>

        <span class="c1">// Make sure we have created all fragments that we need to have shown.</span>
        <span class="n">mInLayout</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="n">populate</span><span class="o">();</span>
        <span class="n">mInLayout</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span></code></pre></div>

<p>正如我所说，减去了已经存在的子view的控件后，剩下的才是page的空间，populate应该会涉及到adapter的一些接口了。我跟进去发现populate调用了populate(mCurItem);意思应该是只对当前显示的页面做populate处理，这段代码比较长，我们需要分段来看：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">ItemInfo</span> <span class="n">oldCurInfo</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">focusDirection</span> <span class="o">=</span> <span class="n">View</span><span class="o">.</span><span class="na">FOCUS_FORWARD</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mCurItem</span> <span class="o">!=</span> <span class="n">newCurrentItem</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">focusDirection</span> <span class="o">=</span> <span class="n">mCurItem</span> <span class="o">&lt;</span> <span class="n">newCurrentItem</span> <span class="o">?</span> <span class="n">View</span><span class="o">.</span><span class="na">FOCUS_RIGHT</span> <span class="o">:</span> <span class="n">View</span><span class="o">.</span><span class="na">FOCUS_LEFT</span><span class="o">;</span>
            <span class="n">oldCurInfo</span> <span class="o">=</span> <span class="n">infoForPosition</span><span class="o">(</span><span class="n">mCurItem</span><span class="o">);</span>
            <span class="n">mCurItem</span> <span class="o">=</span> <span class="n">newCurrentItem</span><span class="o">;</span>
        <span class="o">}</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">mAdapter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sortChildDrawingOrder</span><span class="o">();</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span></code></pre></div>

<p>由于我们是初始化，所以第一个if里面不会进去。然后判断adapter是否会空，如果是空就把现有的子view排序，规则参见ViewPositionComparator。一般情况下这个排序也是白扯，我们不会在viewpage里面添加什么装饰view(就是继承了ViewPage内部定义的接口的类，反正我是没见过有这样的view)：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**</span>
<span class="cm">     * Used internally to tag special types of child views that should be added as</span>
<span class="cm">     * pager decorations by default.</span>
<span class="cm">     */</span>
    <span class="kd">interface</span> <span class="nc">Decor</span> <span class="o">{}</span></code></pre></div>

<p>再接着就比较难理解了，这里还是把android的注释一起贴出来：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// Bail now if we are waiting to populate.  This is to hold off</span>
        <span class="c1">// on creating views from the time the user releases their finger to</span>
        <span class="c1">// fling to a new position until we have finished the scroll to</span>
        <span class="c1">// that position, avoiding glitches from happening at that point.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mPopulatePending</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;populate is pending, skipping for now...&quot;</span><span class="o">);</span>
            <span class="n">sortChildDrawingOrder</span><span class="o">();</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// Also, don&#39;t populate until we are attached to a window.  This is to</span>
        <span class="c1">// avoid trying to populate before we have restored our view hierarchy</span>
        <span class="c1">// state and conflicting with what is restored.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">getWindowToken</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">mAdapter</span><span class="o">.</span><span class="na">startUpdate</span><span class="o">(</span><span class="k">this</span><span class="o">);</span></code></pre></div>

<p>找了半天mPopulatePending，发现只有在处理ACTION_UP事件和endFakeDrag函数中才会被设置为true。endFakeDrag的只能需要看beginFakeDrag的注释，大概用途就是同步与其他可滑动页面的状态。比如我们有两个viewpage，想要达到同时滑动的效果，就在其中一个viewpage滑动的时候调用另一个viewpage的fakedrag系列方法以达到同步效果。但是不管是ACTION_UP还是endFakeDrag都是表示滑动停止，滑动停止后我们的populate函数就沦为了排序？写到这里的时候我也没找到答案，隐约感觉不对劲，但是还是继续往下走。
下面的意思就是在view还没有添加到窗口上时就不走下去了，这里我们需要知道一个view的生命周期：
构造View –&gt; onFinishInflate –&gt; onAttachedToWindow –&gt; onMeasure –&gt; onSizeChanged –&gt; onLayout –&gt; onDraw –&gt; onDetackedFromWindow
再接着 mAdapter.startUpdate(this)这句代码我们上面就说过，并没有什么卵用。</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="kt">int</span> <span class="n">pageLimit</span> <span class="o">=</span> <span class="n">mOffscreenPageLimit</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">startPos</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">mCurItem</span> <span class="o">-</span> <span class="n">pageLimit</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">mAdapter</span><span class="o">.</span><span class="na">getCount</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">endPos</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">mCurItem</span> <span class="o">+</span> <span class="n">pageLimit</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">N</span> <span class="o">!=</span> <span class="n">mExpectedAdapterCount</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">resName</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">resName</span> <span class="o">=</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getResourceName</span><span class="o">(</span><span class="n">getId</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Resources</span><span class="o">.</span><span class="na">NotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">resName</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">getId</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;The application&#39;s PagerAdapter changed the adapter&#39;s&quot;</span> <span class="o">+</span>
                    <span class="s">&quot; contents without calling PagerAdapter#notifyDataSetChanged!&quot;</span> <span class="o">+</span>
                    <span class="s">&quot; Expected adapter item count: &quot;</span> <span class="o">+</span> <span class="n">mExpectedAdapterCount</span> <span class="o">+</span> <span class="s">&quot;, found: &quot;</span> <span class="o">+</span> <span class="n">N</span> <span class="o">+</span>
                    <span class="s">&quot; Pager id: &quot;</span> <span class="o">+</span> <span class="n">resName</span> <span class="o">+</span>
                    <span class="s">&quot; Pager class: &quot;</span> <span class="o">+</span> <span class="n">getClass</span><span class="o">()</span> <span class="o">+</span>
                    <span class="s">&quot; Problematic adapter: &quot;</span> <span class="o">+</span> <span class="n">mAdapter</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
        <span class="o">}</span></code></pre></div>

<p>这一段获取正确的需要初始化的页面起始位置和结束位置。根据我们设置的缓存大小，最大初始化不超过N个页面。然后if里面的错误原因说明很清晰了，改了adapter的数据而没有调用notifyDataSetChanged方法就有可能出现。</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// Locate the currently focused item or add it if needed.</span>
        <span class="kt">int</span> <span class="n">curIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="n">ItemInfo</span> <span class="n">curItem</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">curIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">curIndex</span> <span class="o">&lt;</span> <span class="n">mItems</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">curIndex</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">ItemInfo</span> <span class="n">ii</span> <span class="o">=</span> <span class="n">mItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">curIndex</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ii</span><span class="o">.</span><span class="na">position</span> <span class="o">&gt;=</span> <span class="n">mCurItem</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">ii</span><span class="o">.</span><span class="na">position</span> <span class="o">==</span> <span class="n">mCurItem</span><span class="o">)</span> <span class="n">curItem</span> <span class="o">=</span> <span class="n">ii</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">curItem</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">curItem</span> <span class="o">=</span> <span class="n">addNewItem</span><span class="o">(</span><span class="n">mCurItem</span><span class="o">,</span> <span class="n">curIndex</span><span class="o">);</span>
        <span class="o">}</span></code></pre></div>

<p>正如注释所说，找到当前获得焦点的页面对象，没有就添加进去，很显然，咱们的页面初始化代码出现了。</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">ItemInfo</span> <span class="nf">addNewItem</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ItemInfo</span> <span class="n">ii</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ItemInfo</span><span class="o">();</span>
        <span class="n">ii</span><span class="o">.</span><span class="na">position</span> <span class="o">=</span> <span class="n">position</span><span class="o">;</span>
        <span class="n">ii</span><span class="o">.</span><span class="na">object</span> <span class="o">=</span> <span class="n">mAdapter</span><span class="o">.</span><span class="na">instantiateItem</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">position</span><span class="o">);</span>
        <span class="n">ii</span><span class="o">.</span><span class="na">widthFactor</span> <span class="o">=</span> <span class="n">mAdapter</span><span class="o">.</span><span class="na">getPageWidth</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">mItems</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">mItems</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ii</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">mItems</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">ii</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">ii</span><span class="o">;</span>
    <span class="o">}</span></code></pre></div>

<p>最核心的就是mAdapter.instantiateItem(this, position);和mAdapter.getPageWidth(position);这两个函数了，mAdapter.getPageWidth(position);比较简单，意思是页面占用viewpage的宽度的百分比，默认都是100%，然后看instantiateItem这个函数。instantiateItem是adapter必须实现的方法，默认实现：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**</span>
<span class="cm">     * Create the page for the given position.  The adapter is responsible</span>
<span class="cm">     * for adding the view to the container given here, although it only</span>
<span class="cm">     * must ensure this is done by the time it returns from</span>
<span class="cm">     * {@link #finishUpdate(ViewGroup)}.</span>
<span class="cm">     *</span>
<span class="cm">     * @param container The containing View in which the page will be shown.</span>
<span class="cm">     * @param position The page position to be instantiated.</span>
<span class="cm">     * @return Returns an Object representing the new page.  This does not</span>
<span class="cm">     * need to be a View, but can be some other container of the page.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">instantiateItem</span><span class="o">(</span><span class="n">ViewGroup</span> <span class="n">container</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">instantiateItem</span><span class="o">((</span><span class="n">View</span><span class="o">)</span> <span class="n">container</span><span class="o">,</span> <span class="n">position</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="cm">/**</span>
<span class="cm">     * Create the page for the given position.  The adapter is responsible</span>
<span class="cm">     * for adding the view to the container given here, although it only</span>
<span class="cm">     * must ensure this is done by the time it returns from</span>
<span class="cm">     * {@link #finishUpdate(ViewGroup)}.</span>
<span class="cm">     *</span>
<span class="cm">     * @param container The containing View in which the page will be shown.</span>
<span class="cm">     * @param position The page position to be instantiated.</span>
<span class="cm">     * @return Returns an Object representing the new page.  This does not</span>
<span class="cm">     * need to be a View, but can be some other container of the page.</span>
<span class="cm">     *</span>
<span class="cm">     * @deprecated Use {@link #instantiateItem(ViewGroup, int)}</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">instantiateItem</span><span class="o">(</span><span class="n">View</span> <span class="n">container</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">(</span>
                <span class="s">&quot;Required method instantiateItem was not overridden&quot;</span><span class="o">);</span>
    <span class="o">}</span></code></pre></div>

<p>简直没天理，直接报错……而且让我们使用instantiateItem(ViewGroup, int)，好在我们常用的FragmentPageAdapter里已经实现了：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">instantiateItem</span><span class="o">(</span><span class="n">ViewGroup</span> <span class="n">container</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mCurTransaction</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mCurTransaction</span> <span class="o">=</span> <span class="n">mFragmentManager</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="kt">long</span> <span class="n">itemId</span> <span class="o">=</span> <span class="n">getItemId</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>

        <span class="c1">// Do we already have this fragment?</span>
        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">makeFragmentName</span><span class="o">(</span><span class="n">container</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">itemId</span><span class="o">);</span>
        <span class="n">Fragment</span> <span class="n">fragment</span> <span class="o">=</span> <span class="n">mFragmentManager</span><span class="o">.</span><span class="na">findFragmentByTag</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fragment</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Attaching item #&quot;</span> <span class="o">+</span> <span class="n">itemId</span> <span class="o">+</span> <span class="s">&quot;: f=&quot;</span> <span class="o">+</span> <span class="n">fragment</span><span class="o">);</span>
            <span class="n">mCurTransaction</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="n">fragment</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">fragment</span> <span class="o">=</span> <span class="n">getItem</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Adding item #&quot;</span> <span class="o">+</span> <span class="n">itemId</span> <span class="o">+</span> <span class="s">&quot;: f=&quot;</span> <span class="o">+</span> <span class="n">fragment</span><span class="o">);</span>
            <span class="n">mCurTransaction</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">container</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">fragment</span><span class="o">,</span>
                    <span class="n">makeFragmentName</span><span class="o">(</span><span class="n">container</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">itemId</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fragment</span> <span class="o">!=</span> <span class="n">mCurrentPrimaryItem</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">fragment</span><span class="o">.</span><span class="na">setMenuVisibility</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="n">fragment</span><span class="o">.</span><span class="na">setUserVisibleHint</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">fragment</span><span class="o">;</span>
    <span class="o">}</span></code></pre></div>

<p>这个实现只是适合Fragment，出现了fragment特有的manager和transaction对象，但是中心思想还是一致的，就是也创建一个页面的容器对象，根据android官方注释，生成并返回的这个对象，需要添加到ViewGroup中去，可以看到代码里确实有这句：mCurTransaction.add(container.getId(), fragment, makeFragmentName(container.getId(), itemId));这里也解释了我心中的疑问，这个函数并没有限制返回对象一定需要是view或者fragment，所以理论上我们可以任意创建对象。
接着走我们的populate函数：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// Fill 3x the available width or up to the number of offscreen</span>
        <span class="c1">// pages requested to either side, whichever is larger.</span>
        <span class="c1">// If we have no current item we have no work to do.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">curItem</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">float</span> <span class="n">extraWidthLeft</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="na">f</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">itemIndex</span> <span class="o">=</span> <span class="n">curIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
            <span class="n">ItemInfo</span> <span class="n">ii</span> <span class="o">=</span> <span class="n">itemIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">mItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemIndex</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">clientWidth</span> <span class="o">=</span> <span class="n">getClientWidth</span><span class="o">();</span>
            <span class="kd">final</span> <span class="kt">float</span> <span class="n">leftWidthNeeded</span> <span class="o">=</span> <span class="n">clientWidth</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
                    <span class="mi">2</span><span class="o">.</span><span class="na">f</span> <span class="o">-</span> <span class="n">curItem</span><span class="o">.</span><span class="na">widthFactor</span> <span class="o">+</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">getPaddingLeft</span><span class="o">()</span> <span class="o">/</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">clientWidth</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">mCurItem</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">pos</span><span class="o">--)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">extraWidthLeft</span> <span class="o">&gt;=</span> <span class="n">leftWidthNeeded</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">startPos</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">ii</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">pos</span> <span class="o">==</span> <span class="n">ii</span><span class="o">.</span><span class="na">position</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ii</span><span class="o">.</span><span class="na">scrolling</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mItems</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">itemIndex</span><span class="o">);</span>
                        <span class="n">mAdapter</span><span class="o">.</span><span class="na">destroyItem</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">pos</span><span class="o">,</span> <span class="n">ii</span><span class="o">.</span><span class="na">object</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;populate() - destroyItem() with pos: &quot;</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span>
                                    <span class="s">&quot; view: &quot;</span> <span class="o">+</span> <span class="o">((</span><span class="n">View</span><span class="o">)</span> <span class="n">ii</span><span class="o">.</span><span class="na">object</span><span class="o">));</span>
                        <span class="o">}</span>
                        <span class="n">itemIndex</span><span class="o">--;</span>
                        <span class="n">curIndex</span><span class="o">--;</span>
                        <span class="n">ii</span> <span class="o">=</span> <span class="n">itemIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">mItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemIndex</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">ii</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">==</span> <span class="n">ii</span><span class="o">.</span><span class="na">position</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">extraWidthLeft</span> <span class="o">+=</span> <span class="n">ii</span><span class="o">.</span><span class="na">widthFactor</span><span class="o">;</span>
                    <span class="n">itemIndex</span><span class="o">--;</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="n">itemIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">mItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemIndex</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="n">addNewItem</span><span class="o">(</span><span class="n">pos</span><span class="o">,</span> <span class="n">itemIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
                    <span class="n">extraWidthLeft</span> <span class="o">+=</span> <span class="n">ii</span><span class="o">.</span><span class="na">widthFactor</span><span class="o">;</span>
                    <span class="n">curIndex</span><span class="o">++;</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="n">itemIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">mItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemIndex</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="kt">float</span> <span class="n">extraWidthRight</span> <span class="o">=</span> <span class="n">curItem</span><span class="o">.</span><span class="na">widthFactor</span><span class="o">;</span>
            <span class="n">itemIndex</span> <span class="o">=</span> <span class="n">curIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">extraWidthRight</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">.</span><span class="na">f</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="n">itemIndex</span> <span class="o">&lt;</span> <span class="n">mItems</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">?</span> <span class="n">mItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemIndex</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
                <span class="kd">final</span> <span class="kt">float</span> <span class="n">rightWidthNeeded</span> <span class="o">=</span> <span class="n">clientWidth</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
                        <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">getPaddingRight</span><span class="o">()</span> <span class="o">/</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">clientWidth</span> <span class="o">+</span> <span class="mi">2</span><span class="o">.</span><span class="na">f</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">mCurItem</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">N</span><span class="o">;</span> <span class="n">pos</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">extraWidthRight</span> <span class="o">&gt;=</span> <span class="n">rightWidthNeeded</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="n">endPos</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">ii</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">pos</span> <span class="o">==</span> <span class="n">ii</span><span class="o">.</span><span class="na">position</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ii</span><span class="o">.</span><span class="na">scrolling</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">mItems</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">itemIndex</span><span class="o">);</span>
                            <span class="n">mAdapter</span><span class="o">.</span><span class="na">destroyItem</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">pos</span><span class="o">,</span> <span class="n">ii</span><span class="o">.</span><span class="na">object</span><span class="o">);</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;populate() - destroyItem() with pos: &quot;</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span>
                                        <span class="s">&quot; view: &quot;</span> <span class="o">+</span> <span class="o">((</span><span class="n">View</span><span class="o">)</span> <span class="n">ii</span><span class="o">.</span><span class="na">object</span><span class="o">));</span>
                            <span class="o">}</span>
                            <span class="n">ii</span> <span class="o">=</span> <span class="n">itemIndex</span> <span class="o">&lt;</span> <span class="n">mItems</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">?</span> <span class="n">mItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemIndex</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">ii</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">==</span> <span class="n">ii</span><span class="o">.</span><span class="na">position</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">extraWidthRight</span> <span class="o">+=</span> <span class="n">ii</span><span class="o">.</span><span class="na">widthFactor</span><span class="o">;</span>
                        <span class="n">itemIndex</span><span class="o">++;</span>
                        <span class="n">ii</span> <span class="o">=</span> <span class="n">itemIndex</span> <span class="o">&lt;</span> <span class="n">mItems</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">?</span> <span class="n">mItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemIndex</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">ii</span> <span class="o">=</span> <span class="n">addNewItem</span><span class="o">(</span><span class="n">pos</span><span class="o">,</span> <span class="n">itemIndex</span><span class="o">);</span>
                        <span class="n">itemIndex</span><span class="o">++;</span>
                        <span class="n">extraWidthRight</span> <span class="o">+=</span> <span class="n">ii</span><span class="o">.</span><span class="na">widthFactor</span><span class="o">;</span>
                        <span class="n">ii</span> <span class="o">=</span> <span class="n">itemIndex</span> <span class="o">&lt;</span> <span class="n">mItems</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">?</span> <span class="n">mItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemIndex</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="n">calculatePageOffsets</span><span class="o">(</span><span class="n">curItem</span><span class="o">,</span> <span class="n">curIndex</span><span class="o">,</span> <span class="n">oldCurInfo</span><span class="o">);</span>
        <span class="o">}</span></code></pre></div>

<p>从注释看，说是填满至少3个页面的内容，如果需要的缓存页面更多则填满更多，代码里面getClientWidth();获取的是一个页面的宽度，这个宽度与page页面真实的宽无关，而是viewpage根据自己可显示内容区域大小来确定。
第一个for循环，遍历当前页面的左边，break的条件是两个：extraWidthLeft(应该就是说已经创建的页面)要大于需求的宽度leftWidthNeeded；pos已经超过了需要缓存的索引，也就是pos &lt; startPos；满足上面两个条件后发现左边还有页面对象可以实例化，但是我们不需要了，就会break。
下面我们进入循环看看，首次进入肯定会执行最后面的分支：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">ii</span> <span class="o">=</span> <span class="n">addNewItem</span><span class="o">(</span><span class="n">pos</span><span class="o">,</span> <span class="n">itemIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
                    <span class="n">extraWidthLeft</span> <span class="o">+=</span> <span class="n">ii</span><span class="o">.</span><span class="na">widthFactor</span><span class="o">;</span>
                    <span class="n">curIndex</span><span class="o">++;</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="n">itemIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">mItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemIndex</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span></code></pre></div>

<p>我们需要搞清楚itemIndex是什么，int itemIndex = curIndex - 1;而curIndex代表的意思是当前view应该插入的位置。在我们初始化的时候curIndex=0，因此itemIndex = -1，addNewItem传入的两个参数，第一个pos表示页面索引，第二个itemIndex表示页面在ViewPage的mItems容器中的索引，如果itemIndex的值合理则插入的索引就是itemIndex，否则直接添加到队尾。至于这个在mItems容器中的顺序有何说法我们后面再看。
到最后一句的时候，由于itemIndex = -1，ii赋值null。然后进入第二次循环，可以看到第一个if里面的条件都成立，并且ii=null，直接跳出循环。这里我们不妨假设current！=0，并且我们的mItems里面已经缓存了很多页面的内容。不难看出我们会找到所有左边的缓存，当我们需要的缓存都找到或者创建出来后，会进入：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">(</span><span class="n">pos</span> <span class="o">==</span> <span class="n">ii</span><span class="o">.</span><span class="na">position</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ii</span><span class="o">.</span><span class="na">scrolling</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mItems</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">itemIndex</span><span class="o">);</span>
                        <span class="n">mAdapter</span><span class="o">.</span><span class="na">destroyItem</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">pos</span><span class="o">,</span> <span class="n">ii</span><span class="o">.</span><span class="na">object</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;populate() - destroyItem() with pos: &quot;</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span>
                                    <span class="s">&quot; view: &quot;</span> <span class="o">+</span> <span class="o">((</span><span class="n">View</span><span class="o">)</span> <span class="n">ii</span><span class="o">.</span><span class="na">object</span><span class="o">));</span>
                        <span class="o">}</span>
                        <span class="n">itemIndex</span><span class="o">--;</span>
                        <span class="n">curIndex</span><span class="o">--;</span>
                        <span class="n">ii</span> <span class="o">=</span> <span class="n">itemIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">mItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemIndex</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="o">}</span></code></pre></div>

<p>这个分支会把所有左边多余的分支删除销毁。
对称的，我们还需要处理当前页面的右边内容。与左边不同的是计算rightWidthNeeded的时候，我们可以看到leftWidthNeeded基本是等于1.0f的，而rightWidthNeeded确实等于2.0f，正如我们最一开始所说的，至少需要缓存3x的页面内容，但是这个分配默认是不对称的左1x右2x。
在我们把currentItem以及左右缓存都准备好了后进入下一句：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">calculatePageOffsets</span><span class="o">(</span><span class="n">curItem</span><span class="o">,</span> <span class="n">curIndex</span><span class="o">,</span> <span class="n">oldCurInfo</span><span class="o">);</span></code></pre></div>

<p>对于我们初始化来说可以直接变成：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">calculatePageOffsets</span><span class="o">(</span><span class="n">curItem</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span></code></pre></div>

<p>calculatePageOffsets也是一个比较复制的函数，本来我们不需要看前面第一个if里面的逻辑，因为iewomendeoldCurInfo是null。但是当我们不是初始化的时候，calculatePageOffsets又干了什么呢？
首先判断oldCurInfo是在curItem哪一侧，这里左右其实对称的操作，我们假设是在左侧。
然后对oldCurInfo和curItem之间(包含curItem)的item进行遍历，统计每一个item的offset(这个offset是相对oldCurInfo来计算的)。这个过程就涉及到我们上面说的如果addNewItem的pos和itemIndex不一致的情况。calculatePageOffsets函数是这么处理的：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">while</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="n">ii</span><span class="o">.</span><span class="na">position</span> <span class="o">&amp;&amp;</span> <span class="n">itemIndex</span> <span class="o">&lt;</span> <span class="n">mItems</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">itemIndex</span><span class="o">++;</span>
                        <span class="n">ii</span> <span class="o">=</span> <span class="n">mItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemIndex</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ii</span><span class="o">.</span><span class="na">position</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// We don&#39;t have an item populated for this,</span>
                        <span class="c1">// ask the adapter for an offset.</span>
                        <span class="n">offset</span> <span class="o">+=</span> <span class="n">mAdapter</span><span class="o">.</span><span class="na">getPageWidth</span><span class="o">(</span><span class="n">pos</span><span class="o">)</span> <span class="o">+</span> <span class="n">marginOffset</span><span class="o">;</span>
                        <span class="n">pos</span><span class="o">++;</span>
                    <span class="o">}</span></code></pre></div>

<p>第一个while按照mItems里面的顺序找到pos右边(包含pos)的一个item，第二个while判断如果找到的item的position值不是pos，这说明这两个position之间的item我们没有创建（不一定是没创建，但是如果我们在addNewItem的时候pos和itemIndex不是同升同降的话就有可能会出现这种情况，这也是为何每次dataSetChanged都会对mItems排序的原因吧），我需要问adapter如何计算offset。</p>

<p>正当我沾沾自喜看懂了第一段代码是计算oldCurInfo和curItem的position值之间的对应的item的基于oldCurInfo的offset后，下面一段代码就像给我一大嘴巴，下面的代码正如注释所说，计算基于curItem的每个page的offset</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// Base all offsets off of curItem.</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">itemCount</span> <span class="o">=</span> <span class="n">mItems</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="kt">float</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">curItem</span><span class="o">.</span><span class="na">offset</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">curItem</span><span class="o">.</span><span class="na">position</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">mFirstOffset</span> <span class="o">=</span> <span class="n">curItem</span><span class="o">.</span><span class="na">position</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">curItem</span><span class="o">.</span><span class="na">offset</span> <span class="o">:</span> <span class="o">-</span><span class="n">Float</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>
        <span class="n">mLastOffset</span> <span class="o">=</span> <span class="n">curItem</span><span class="o">.</span><span class="na">position</span> <span class="o">==</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">?</span>
                <span class="n">curItem</span><span class="o">.</span><span class="na">offset</span> <span class="o">+</span> <span class="n">curItem</span><span class="o">.</span><span class="na">widthFactor</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">Float</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>
        <span class="c1">// Previous pages</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">curIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--,</span> <span class="n">pos</span><span class="o">--)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">ItemInfo</span> <span class="n">ii</span> <span class="o">=</span> <span class="n">mItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="n">ii</span><span class="o">.</span><span class="na">position</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">offset</span> <span class="o">-=</span> <span class="n">mAdapter</span><span class="o">.</span><span class="na">getPageWidth</span><span class="o">(</span><span class="n">pos</span><span class="o">--)</span> <span class="o">+</span> <span class="n">marginOffset</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">offset</span> <span class="o">-=</span> <span class="n">ii</span><span class="o">.</span><span class="na">widthFactor</span> <span class="o">+</span> <span class="n">marginOffset</span><span class="o">;</span>
            <span class="n">ii</span><span class="o">.</span><span class="na">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ii</span><span class="o">.</span><span class="na">position</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="n">mFirstOffset</span> <span class="o">=</span> <span class="n">offset</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">curItem</span><span class="o">.</span><span class="na">offset</span> <span class="o">+</span> <span class="n">curItem</span><span class="o">.</span><span class="na">widthFactor</span> <span class="o">+</span> <span class="n">marginOffset</span><span class="o">;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">curItem</span><span class="o">.</span><span class="na">position</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
        <span class="c1">// Next pages</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">curIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">itemCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++,</span> <span class="n">pos</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">ItemInfo</span> <span class="n">ii</span> <span class="o">=</span> <span class="n">mItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ii</span><span class="o">.</span><span class="na">position</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="n">mAdapter</span><span class="o">.</span><span class="na">getPageWidth</span><span class="o">(</span><span class="n">pos</span><span class="o">++)</span> <span class="o">+</span> <span class="n">marginOffset</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ii</span><span class="o">.</span><span class="na">position</span> <span class="o">==</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mLastOffset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">ii</span><span class="o">.</span><span class="na">widthFactor</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">ii</span><span class="o">.</span><span class="na">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="o">;</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">ii</span><span class="o">.</span><span class="na">widthFactor</span> <span class="o">+</span> <span class="n">marginOffset</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">mNeedCalculatePageOffsets</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span></code></pre></div>

<p>也就是说到这儿，curItem的offset是基于oldCurInfo算出来的，然后其他的item的offset都是基于curItem算出来的。这是在弄啥咧？？我们继续回到populate的代码中去：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">mAdapter</span><span class="o">.</span><span class="na">setPrimaryItem</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">mCurItem</span><span class="o">,</span> <span class="n">curItem</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">curItem</span><span class="o">.</span><span class="na">object</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">mAdapter</span><span class="o">.</span><span class="na">finishUpdate</span><span class="o">(</span><span class="k">this</span><span class="o">);</span></code></pre></div>

<p>默认实现为空，意思就是通知Page你已经成为了主page，即将要显示，做点什么吧。FragmentPageAdapter实现如下：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPrimaryItem</span><span class="o">(</span><span class="n">ViewGroup</span> <span class="n">container</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Fragment</span> <span class="n">fragment</span> <span class="o">=</span> <span class="o">(</span><span class="n">Fragment</span><span class="o">)</span><span class="n">object</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fragment</span> <span class="o">!=</span> <span class="n">mCurrentPrimaryItem</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mCurrentPrimaryItem</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mCurrentPrimaryItem</span><span class="o">.</span><span class="na">setMenuVisibility</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                <span class="n">mCurrentPrimaryItem</span><span class="o">.</span><span class="na">setUserVisibleHint</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">fragment</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">fragment</span><span class="o">.</span><span class="na">setMenuVisibility</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="n">fragment</span><span class="o">.</span><span class="na">setUserVisibleHint</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">mCurrentPrimaryItem</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></div>

<p>相信大家都不陌生，设置了fragment的menu和visible状态。最后populate还有一段代码：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// Check width measurement of current pages and drawing sort order.</span>
        <span class="c1">// Update LayoutParams as needed.</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">childCount</span> <span class="o">=</span> <span class="n">getChildCount</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">childCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">View</span> <span class="n">child</span> <span class="o">=</span> <span class="n">getChildAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="kd">final</span> <span class="n">LayoutParams</span> <span class="n">lp</span> <span class="o">=</span> <span class="o">(</span><span class="n">LayoutParams</span><span class="o">)</span> <span class="n">child</span><span class="o">.</span><span class="na">getLayoutParams</span><span class="o">();</span>
            <span class="n">lp</span><span class="o">.</span><span class="na">childIndex</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">lp</span><span class="o">.</span><span class="na">isDecor</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">.</span><span class="na">widthFactor</span> <span class="o">==</span> <span class="mi">0</span><span class="o">.</span><span class="na">f</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 0 means requery the adapter for this, it doesn&#39;t have a valid width.</span>
                <span class="kd">final</span> <span class="n">ItemInfo</span> <span class="n">ii</span> <span class="o">=</span> <span class="n">infoForChild</span><span class="o">(</span><span class="n">child</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">ii</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">lp</span><span class="o">.</span><span class="na">widthFactor</span> <span class="o">=</span> <span class="n">ii</span><span class="o">.</span><span class="na">widthFactor</span><span class="o">;</span>
                    <span class="n">lp</span><span class="o">.</span><span class="na">position</span> <span class="o">=</span> <span class="n">ii</span><span class="o">.</span><span class="na">position</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">sortChildDrawingOrder</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">hasFocus</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">View</span> <span class="n">currentFocused</span> <span class="o">=</span> <span class="n">findFocus</span><span class="o">();</span>
            <span class="n">ItemInfo</span> <span class="n">ii</span> <span class="o">=</span> <span class="n">currentFocused</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">infoForAnyChild</span><span class="o">(</span><span class="n">currentFocused</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ii</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">ii</span><span class="o">.</span><span class="na">position</span> <span class="o">!=</span> <span class="n">mCurItem</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">getChildCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">View</span> <span class="n">child</span> <span class="o">=</span> <span class="n">getChildAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="n">infoForChild</span><span class="o">(</span><span class="n">child</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">ii</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">ii</span><span class="o">.</span><span class="na">position</span> <span class="o">==</span> <span class="n">mCurItem</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">child</span><span class="o">.</span><span class="na">requestFocus</span><span class="o">(</span><span class="n">focusDirection</span><span class="o">))</span> <span class="o">{</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span></code></pre></div>

<p>第一段正如注释所说，更新当前viewpage上面所有子view的LayoutParam信息，然后对他们进行排序，这里的顺序是绘制顺序，规则就是先按照position顺序绘制page，最后绘制Decor对象，具体参见ViewPositionComparator的定义。后面一段是焦点的处理，究竟应该是谁来获得焦点，infoForAnyChild(currentFocused)很有意思，这个函数获取的应该是currentFocused这个view所在的page的iteminfo对象，这样来判断焦点是否处于同一个page没变化，否则就需要遍历所有子view来寻找下一个焦点应该在哪儿。具体寻找焦点的代码比较复杂，层级太深，这里就不跟进去了，以后有时间专门研究一次child.requestFocus(focusDirection)是怎么找到正确的应该获取焦点的view的。</p>

<p>OK，我们终于从populate中出来了，继续回到onMeasure，onMeasure也还剩最后一段：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// Page views next.</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">getChildCount</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">View</span> <span class="n">child</span> <span class="o">=</span> <span class="n">getChildAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">child</span><span class="o">.</span><span class="na">getVisibility</span><span class="o">()</span> <span class="o">!=</span> <span class="n">GONE</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Measuring #&quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">child</span>
                        <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">mChildWidthMeasureSpec</span><span class="o">);</span>

                <span class="kd">final</span> <span class="n">LayoutParams</span> <span class="n">lp</span> <span class="o">=</span> <span class="o">(</span><span class="n">LayoutParams</span><span class="o">)</span> <span class="n">child</span><span class="o">.</span><span class="na">getLayoutParams</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">lp</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">lp</span><span class="o">.</span><span class="na">isDecor</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="kt">int</span> <span class="n">widthSpec</span> <span class="o">=</span> <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">makeMeasureSpec</span><span class="o">(</span>
                            <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">childWidthSize</span> <span class="o">*</span> <span class="n">lp</span><span class="o">.</span><span class="na">widthFactor</span><span class="o">),</span> <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">EXACTLY</span><span class="o">);</span>
                    <span class="n">child</span><span class="o">.</span><span class="na">measure</span><span class="o">(</span><span class="n">widthSpec</span><span class="o">,</span> <span class="n">mChildHeightMeasureSpec</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span></code></pre></div>

<table>
  <tbody>
    <tr>
      <td>我百思不得其解if (lp == null</td>
      <td> </td>
      <td>!lp.isDecor)为何不会出错，如果lp为null，里面的 lp.widthFactor不会报空指针异常的错误么，不过抛开这个疑问，代码的主要功能就是测量子view，与一般的viewgroup一致。</td>
    </tr>
  </tbody>
</table>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-06-23T09:19:36+08:00"><a href="/android/android-udp/">June 23, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About 陆 伟">陆 伟</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
        Reading time ~6 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/android/android-udp/" rel="bookmark" title="Android UDP服务" itemprop="url">Android UDP服务</a></h1>
    
  </header>
  <div class="entry-content">
    <h3 id="kryonet">已经有的轮子：KryoNet</h3>

<p><a href="https://github.com/EsotericSoftware/kryonet">KryoNet</a> is a Java library that provides a clean and simple API for efficient TCP and UDP client/server network 
communication using NIO. KryoNet uses the Kryo serialization library to automatically and efficiently transfer object graphs across the network.</p>

<p>正如KryoNet的描述，这个框架已经提供了可用的udp服务器和客户端实现，但是使用的是<a href="https://github.com/EsotericSoftware/kryo">Kryo</a>来做字节的序列化和反序列化。
我只是想要一个UDP服务器的demo，不想绑定Kryo，而且由于项目需求，字节码解析协议需要定制，于是就有了这篇博客。</p>

<h3 id="udpdemo">一个完整的UDP服务器Demo应该有什么？</h3>

<p>先帖一发<a href="https://luoqiaowei@bitbucket.org/luoqiaowei/udpdemo.git">代码库</a>。这里使用的bibucket建仓库，实在是点不开github…
一个完整的UDP服务器应该能做到下面的事情：</p>

<p>Server端：</p>

<ol>
  <li>端口监听。防止dos攻击、报文过滤等等都应该做在这一层。</li>
  <li>连接池。接收到UDP报文后肯定需要创建连接然后发送ACK或者其他数据，如果不考虑性能，连接池可以省略，我的demo里面也没有实现，都是直接new出来的。</li>
  <li>连接记录。虽然都说UDP是无连接的协议，但是大部分需求都是需要记录UDP连接的，这样才能发送广播之类的消息；同时如果想要使用UDP来实现一套IM系统，肯定还是需要连接记录的。</li>
  <li>数据解析处理。</li>
  <li>可靠的数据传递。(超时重发、超重发次数离线)</li>
  <li>心跳检测。独立的线程遍历连接记录，发现有心跳超时的记录就”断开连接”，连接池回收。</li>
</ol>

<p>Client端：</p>

<ol>
  <li>端口监听。逻辑跟服务器一样一样。</li>
  <li>建立连接。不要以为UDP服务无连接就不需要这一步，一般都是发送一个心跳包，等待服务器的ACK，如果等到了就说明链路通了，否则需要提示用户无法建立连接</li>
  <li>可靠的数据传递。超时重发、超重发次数离线并且重连、超重连次数通知上层逻辑处理。</li>
  <li>数据解析处理。</li>
  <li>心跳。</li>
</ol>

<p>目前我的Demo里面实现的功能很简陋，Server端什么都没有，收到消息直接返回ACK。这个Server本身也只是在项目中用来测试客户端是否正确，并没有花时间来做。Client端相对丰满点，实现了：</p>

<ol>
  <li>端口监听。没有防DOS攻击等复杂逻辑，简单地收取报文。</li>
  <li>建立连接。</li>
  <li>可靠的数据传递。只做了超时重发、超重发次数重连，没有保存本地数据库。</li>
  <li>数据解析处理。</li>
  <li>心跳</li>
</ol>

<h3 id="udp">UDP连接框架</h3>
<figure>
	<img src="/images/android/UDP/UDP_Connection.png" alt="UDP连接ER图" />
	<figcaption>UDP连接ER图</figcaption>
</figure>
<p>首先需要熟悉下<a href="http://tutorials.jenkov.com/java-nio/selectors.html">Java里面的NIO</a>，有一个对应的<a href="http://ifeve.com/overview/">翻译</a>，最主要的是要看到第9篇，
这样就知道了如果搭建一个简单地UDP服务器了。
这些最基础的UDP连接，对应封装在UDPConnection类中：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UDPConnection</span> <span class="o">{</span>
    <span class="n">InetSocketAddress</span> <span class="n">connectedAddress</span><span class="o">;</span>
    <span class="n">DatagramChannel</span> <span class="n">datagramChannel</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">ByteBuffer</span> <span class="n">readBuffer</span><span class="o">,</span> <span class="n">writeBuffer</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Serialization</span> <span class="n">serialization</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">SelectionKey</span> <span class="n">selectionKey</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">writeLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Object</span><span class="o">();</span>
    <span class="o">......</span>
<span class="o">}</span></code></pre></div>

<p>从成员变量里面就可以看出来，与NIO的教程里面说的一样有三个角色：buffer、Channel和SelectionKey。同时还有另一个角色：Serialization，也就是我们下面着重会讲的数据解析协议，这个类规定了</p>

<ol>
  <li>如何从ByteBuffer转化为我们需要的Java对象</li>
  <li>如何从Java对象转化为ByteBuffer</li>
</ol>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">UDPConnection</span><span class="o">(</span><span class="n">Serialization</span> <span class="n">serialization</span><span class="o">,</span> <span class="kt">int</span> <span class="n">writeBufferSize</span><span class="o">,</span> <span class="kt">int</span> <span class="n">objectBufferSize</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">serialization</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">;</span>
        <span class="n">readBuffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">objectBufferSize</span><span class="o">);</span>
        <span class="n">writeBuffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="n">writeBufferSize</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">bind</span><span class="o">(</span><span class="n">Selector</span> <span class="n">selector</span><span class="o">,</span> <span class="n">InetSocketAddress</span> <span class="n">localPort</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">close</span><span class="o">();</span>
        <span class="n">readBuffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">writeBuffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">datagramChannel</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">provider</span><span class="o">().</span><span class="na">openDatagramChannel</span><span class="o">();</span>
            <span class="n">datagramChannel</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="n">localPort</span><span class="o">);</span>
            <span class="n">datagramChannel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="n">selectionKey</span> <span class="o">=</span> <span class="n">datagramChannel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">();</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></div>

<p>先看构造函数和bind。构造函数中传入了具体的Serialization，以及各个缓存的大小。
bind函数作用就是在给定的端口上监听UDP报文，这里使用selector.provider().openDatagramChannel()而不是DatagramChannel.open()还是有一点区别的，方便了我们扩展代码。</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">connect</span><span class="o">(</span><span class="n">Selector</span> <span class="n">selector</span><span class="o">,</span> <span class="n">InetSocketAddress</span> <span class="n">remoteAddress</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">close</span><span class="o">();</span>
        <span class="n">readBuffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">writeBuffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">datagramChannel</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">provider</span><span class="o">().</span><span class="na">openDatagramChannel</span><span class="o">();</span>
            <span class="n">datagramChannel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="n">datagramChannel</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
            <span class="n">datagramChannel</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">connect</span><span class="o">(</span><span class="n">remoteAddress</span><span class="o">);</span>
            <span class="n">selectionKey</span> <span class="o">=</span> <span class="n">datagramChannel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
            <span class="n">connectedAddress</span> <span class="o">=</span> <span class="n">remoteAddress</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">();</span>
            <span class="n">IOException</span> <span class="n">ioEx</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">&quot;Unable to connect to: &quot;</span> <span class="o">+</span> <span class="n">remoteAddress</span><span class="o">);</span>
            <span class="n">ioEx</span><span class="o">.</span><span class="na">initCause</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
            <span class="k">throw</span> <span class="n">ioEx</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></div>

<p>看到这个方法可能会让人有点困惑，UDP是无连接的，为何还会有connect方法？这里的connect并不是TCP中的建立连接的意思，而是把Channel与该地址绑定，这样以后写数据的时候就会默认写给connect中传入的地址。具体描述可参见<a href="http://tool.oschina.net/uploads/apidocs/jdk-zh/java/nio/channels/DatagramChannel.html#connect(java.net.SocketAddress)">官方文档</a></p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">InetSocketAddress</span> <span class="nf">readFromAddress</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="n">DatagramChannel</span> <span class="n">datagramChannel</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">datagramChannel</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">datagramChannel</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">SocketException</span><span class="o">(</span><span class="s">&quot;ConnectionWrapper is closed.&quot;</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">datagramChannel</span><span class="o">.</span><span class="na">isConnected</span><span class="o">())</span>
                <span class="k">return</span> <span class="o">(</span><span class="n">InetSocketAddress</span><span class="o">)</span> <span class="n">datagramChannel</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="n">readBuffer</span><span class="o">);</span> <span class="c1">// always null on Android &gt;= 5.0</span>
            <span class="n">datagramChannel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">readBuffer</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">connectedAddress</span><span class="o">;</span>
        <span class="o">}</span>
    
        <span class="kd">public</span> <span class="n">PacketMessage</span> <span class="nf">readObject</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">readBuffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">PacketMessage</span> <span class="n">object</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">readBuffer</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">readBuffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="s">&quot;Incorrect number of bytes (&quot;</span> <span class="o">+</span> <span class="n">readBuffer</span><span class="o">.</span><span class="na">remaining</span><span class="o">()</span>
                                <span class="o">+</span> <span class="s">&quot; remaining) used to deserialize object: &quot;</span> <span class="o">+</span> <span class="n">object</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">info</span><span class="o">(</span><span class="s">&quot;readObject object : &quot;</span> <span class="o">+</span> <span class="n">object</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
                    <span class="k">return</span> <span class="n">object</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Error during deserialization.&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">readBuffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    
        <span class="cm">/**</span>
<span class="cm">         * This method is thread safe.</span>
<span class="cm">         */</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">send</span><span class="o">(</span><span class="n">PacketMessage</span> <span class="n">object</span><span class="o">,</span> <span class="n">SocketAddress</span> <span class="n">address</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="n">DatagramChannel</span> <span class="n">datagramChannel</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">datagramChannel</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">datagramChannel</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">SocketException</span><span class="o">(</span><span class="s">&quot;ConnectionWrapper is closed.&quot;</span><span class="o">);</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">writeLock</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">info</span><span class="o">(</span><span class="s">&quot;send object : &quot;</span> <span class="o">+</span> <span class="n">object</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
                        <span class="n">serialization</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">writeBuffer</span><span class="o">,</span> <span class="n">object</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Error serializing object of type: &quot;</span> <span class="o">+</span> <span class="n">object</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">ex</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">writeBuffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
                    <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">writeBuffer</span><span class="o">.</span><span class="na">limit</span><span class="o">();</span>
                    <span class="n">datagramChannel</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">writeBuffer</span><span class="o">,</span> <span class="n">address</span><span class="o">);</span>
                    <span class="kt">boolean</span> <span class="n">wasFullWrite</span> <span class="o">=</span> <span class="o">!</span><span class="n">writeBuffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">();</span>
                    <span class="k">return</span> <span class="n">wasFullWrite</span> <span class="o">?</span> <span class="n">length</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">writeBuffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span></code></pre></div>

<p>这三个方法中readFromAddress是从通道中读取数据到ByteBuffer，readObject使用规定的Serialization从ByteBuffer转为Java对象，send将Java对象写入通道。有了这些基础方法后就可以在上层设计UDP连接框架了。</p>

<p>这里使用了静态代理的设计思路，UDPConnection是IConnection的一个实现，ConnectionWrapper是IConnection的一个代理；ConnectionWrapper中使用的是UDPConnection的实现。ConnectionWrapper中还有一个属性是EndPoint类型的对象，ConnectionWrapper中主要使用的是EndPoint的reconnect实现。</p>

<p>EndPoint定义了一个UDP端的控制接口。</p>

<ol>
  <li>Serialization getSerialization(); 获取数据序列化的实现</li>
  <li>addListener(Listener listener); 添加上面所说的五中状态的监听</li>
  <li>removeListener(Listener listener);删除状态监听</li>
  <li>run();继承的Runnable，读取消息的循环，运行在独立线程中</li>
  <li>reconnect();重连</li>
  <li>start();开启一个线程运行run()</li>
  <li>stop();停止run()并重置Selector状态</li>
  <li>close();状态置为关闭，关闭通道，重置Selector</li>
  <li>update(int timeout);读取一次数据的实现，run中会循环调用该方法</li>
  <li>getUpdateThread();获取读取数据的线程，这是为了判断建立连接的线程与读取数据的线程是否相同，建立连接的过程会block线程，因此不能使用同一个线程，否则会卡死。</li>
</ol>

<p>这些接口里面只有1、2、3、5、6、7、8是提供给外部控制Client状态的。</p>

<p>下面我们来走一遍建立连接的过程:</p>

<ol>
  <li>
    <p>创建Client</p>

    <p>client = new Client() {};</p>
  </li>
  <li>
    <p>配置状态回调，启动Client，开始监听UDP报文</p>

    <p>client.start();</p>

    <p>client.addListener(new com.transport.Listener());</p>
  </li>
  <li>
    <p>开启另一个线程开始连接服务器</p>
  </li>
</ol>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="s">&quot;Connect&quot;</span><span class="o">)</span> <span class="o">{</span>
       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
           <span class="k">try</span> <span class="o">{</span>
               <span class="n">client</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">port</span><span class="o">));</span> 
           <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
               <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
           <span class="o">}</span>
       <span class="o">}</span>
   <span class="o">}.</span><span class="na">start</span><span class="o">();</span></code></pre></div>

<p>需要注意的是必须要先启动Client后在建立连接，因为我们这里建立连接做的事情是1.给Channel绑定服务器的地址 2.给服务器发送一个心跳包，然后block线程，等待心跳ACK，超时断开连接；收到ACK唤醒线程，通知状态监听</p>

<p>服务器的逻辑与之类似：</p>

<ol>
  <li>
    <p>创建Server</p>

    <p>server = new Server() {};</p>
  </li>
  <li>
    <p>配置状态回调，启动Client，开始监听UDP报文，收到报文后默认返回ACK</p>

    <p>server.addListener(new Listener());</p>

    <p>server.start();</p>
  </li>
  <li>
    <p>绑定端口，服务器没有建立连接的步骤，不会造成线程block</p>

    <p>server.bind(54555);</p>
  </li>
</ol>

<h3 id="section">可靠地数据传输</h3>

<p>要实现可靠地数据传输需要实现两个特性：1.断线重连 2.数据包ACK，超时重发 3.心跳</p>

<h4 id="section-1">断线重连</h4>

<p>断线重连发生在下面几种情况下：</p>

<ol>
  <li>从通道读取数据失败。我们认为数据通道被破坏了，需要重新创建。</li>
  <li>ACK检查时发现了超出重发次数的数据包。我们认为服务器失联了，需要重联，确认连接可用。</li>
  <li>发送数据包失败。与1一样，认为数据通道破坏了。</li>
</ol>

<p>对应的代码调用可以全局搜索reconnect();的调用</p>

<h4 id="section-2">超时重发</h4>
<p>上面在介绍EndPoint的时候说过了update(int timeout)，运行在独立的线程中，这个方法做了3件事情：</p>

<ol>
  <li>检测Selector是否有数据通道处于ready状态，如果有，进入读取数据的逻辑。</li>
  <li>检测并发送心跳包。</li>
  <li>检测等待ACK的包，是否有等待的包超时了，有并且已经超出重发次数上线，重连；没有超出重发次数上线则重发数据包，并将该数据包移出等待ACK的列表。</li>
</ol>

<p>我们在发送数据包时，需要将每一个发送成功的数据包保存在等待ACK的列表中，在收到了对应的ACK后才能将之移除；重连时需要把还在等待ACK的数据包重发一次。</p>

<h4 id="section-3">心跳</h4>

<p>心跳也是在update函数中检测的，目前定义的是一分钟一次，在update函数中判断距离上次发送心跳的时间，到了一分钟就发送一次心跳，然后重置最近一次发送心跳的时间。这里需要注意的
是重置发送心跳的时间是写在发送数据包的函数中的，因为我们有可能会出现心跳包重发的情况，因此在发送数据包的时候来判断是否属心跳包，以此为依据来更新最新一次数据包的发送时间。
重连的时候不会发送还在等待ACK的心跳包，心跳包会直接抛弃。</p>

<h3 id="section-4">数据解析协议</h3>

<p>首先需要看下序列化接口的定义：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Serialization</span> <span class="o">{</span>

    <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">buffer</span><span class="o">,</span> <span class="n">PacketMessage</span> <span class="n">packet</span><span class="o">);</span>

    <span class="n">PacketMessage</span> <span class="nf">read</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">buffer</span><span class="o">);</span>

    <span class="cm">/**</span>
<span class="cm">     * The fixed number of bytes that will be written by {@link #writeLength(ByteBuffer, int)} and read by</span>
<span class="cm">     * {@link #readLength(ByteBuffer)}.</span>
<span class="cm">     */</span>
    <span class="kt">int</span> <span class="nf">getLengthLength</span><span class="o">();</span>

    <span class="kt">void</span> <span class="nf">writeLength</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">buffer</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">);</span>

    <span class="kt">int</span> <span class="nf">readLength</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">buffer</span><span class="o">);</span>
<span class="o">}</span></code></pre></div>

<p>这里我们规定了ByteBuffer与PacketMessage之间的互相转化接口，具体实现写在PacketSerialization中。这里不太想赘述了，代码中已经写得很详细了。</p>

<h3 id="demo">如何运行Demo</h3>

<p>我们虽然导入Android Studio后是一个Android工程，但是不能启动模拟器来运行，因为Android部分的代码都被我删掉了。我们可以运行代码里面的ChatClient
和ChatServer两个Java勒种的main方法，运行方法不需要我再说了吧，附上截图：</p>
<figure>
	<img src="/images/android/UDP/ChatServer.png" alt="服务器运行图" /> 
	<img src="/images/android/UDP/ChatClient01.png" alt="客户端设置服务器地址" /> 
	<img src="/images/android/UDP/ChatClient02.png" alt="客户端设置服务器端口" /> 
	<img src="/images/android/UDP/ChatClient03.png" alt="客户端运行图" /> 
</figure>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2015-11-05T14:43:14+08:00"><a href="/ios/record/yymodel/">November 05, 2015</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About 陆 伟">陆 伟</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
        Reading time ~23 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/ios/record/yymodel/" rel="bookmark" title="学习YYModel" itemprop="url">学习YYModel</a></h1>
    
  </header>
  <div class="entry-content">
    <h3 id="section">序列化和反序列化</h3>
<hr />
<p>相信很多人都用过类的序列化和反序列化，在Android里面有Gson等第三方库可以做到，在IOS里面有setValuesForKeysWithDictionary这个方法。但是setValuesForKeysWithDictionary这个方法只能设置键值对，遇到复杂的例如Iva对象就没办法处理了。我们都知道一个实体类里面包含的数据有两类：方法和属性，其中属性又分为基本类型、容器类型和实体(对象)类型。C++里面的基本类型就那么几种：int、float、byte等。在IOS里面如果一个实体类只包含这些基本类型，那就可以通过- (void)setValuesForKeysWithDictionary:(NSDictionary&lt;NSString *, id&gt;; *)keyedValues;直接将一个从json字符串中提取出来的字典转为实体类，当然你必须实现-(void)setValue:(id)value forUndefinedKey:(NSString *)key方法，以防服务器返回的字段跟你实体类定义的名字不一样。</p>

<h3 id="ios">IOS中如何处理一般实体类的序列化</h3>
<hr />
<p>前面我们说Android里面有很多第三方库可以做到，IOS也是如此：<a href="https://github.com/Mantle/Mantle">Mantle</a>、<a href="https://github.com/icanzilb/JSONModel">JSONModel</a>、<a href="https://github.com/Yalantis/FastEasyMapping">FastEasyMapping</a>、<a href="https://github.com/CoderMJLee/MJExtension">MJExtension</a>、<a href="https://github.com/ibireme/YYKit">YYModel</a>等等。
其中我选取了YYModel作为学习对象，因为这个库文件最少最简单，而且根据他自己的介绍来看，貌似效率挺不错。</p>

<h4 id="id">什么是id</h4>
<p>要对一个类序列化首先需要知道IOS里面对象的结构。我们知道C里面是没有类的，只有结构体。C++在C的结构体基础上提出了类的概念和结构，OC也是如此，OC的类就是结构体。在OC里面的对象都可以使用id类型来表示，A *a也可以写成 id a。那么id是什么呢，id在objc.h中定义如下：</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="c1">//A pointer to an instance of a class.</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">objc_object</span> <span class="o">*</span><span class="kt">id</span><span class="p">;</span></code></pre></div>

<p>就像注释中所说的这样id是指向一个objc_object结构体的指针。objc_object在objc.h中的定义：</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="c1">//Represents an instance of a class.</span>
<span class="k">struct</span> <span class="n">objc_object</span>
<span class="p">{</span>
    <span class="kt">Class</span> <span class="n">isa</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>这个时候我们知道OBjective-C中的object在最后会被转换成C的结构体，而在这个struct中有一个isa指针，指向它的类别Class(C是大写的):</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="c1">//Represents an instance of a class.</span>
<span class="c1">//An opaque type that represents an Objective-C class</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">objc_class</span> <span class="o">*</span><span class="kt">Class</span><span class="p">;</span></code></pre></div>

<p>我们可以看到，Class本身也是指向一个C的structobjc_class:</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="k">struct</span> <span class="n">objc_class</span>
<span class="p">{</span>
    <span class="kt">Class</span> <span class="n">isa</span> <span class="n">OBJC_ISA_AVAILABILITY</span><span class="p">;</span>

    <span class="kt">Class</span> <span class="n">super_class</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">version</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">info</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">instance_size</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">objc_ivar_list</span> <span class="o">*</span><span class="n">ivars</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">objc_method_list</span> <span class="o">**</span><span class="n">methodLists</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">objc_cache</span> <span class="o">*</span><span class="n">cache</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">objc_protocol_list</span> <span class="o">*</span><span class="n">protocols</span><span class="p">;</span> 
<span class="p">};</span></code></pre></div>

<p>该结构中，isa指向所属的Class,super_class指向父类别。在objc_runtime_new.h中，我们发现objc_class有如下定义：</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="k">struct</span> <span class="nl">object_class</span> <span class="p">:</span> <span class="n">objc_object</span>
<span class="p">{</span>
    <span class="c1">//Class ISA</span>
    <span class="kt">Class</span> <span class="n">superclass</span><span class="p">;</span>

    <span class="p">...</span>
    <span class="p">...</span>
<span class="p">}</span></code></pre></div>

<h4 id="meta-class">什么是Meta Class</h4>
<p>根据上面的描述，我们可以把Meta Class理解为一个Class对象的class。简单的说：</p>

<ul>
  <li>当我们发送一个消息给一个NSObject对象时，这条消息会在对象类的方法列表里查找。</li>
  <li>当我们发送一个消息给一个类时，这条消息会在类的Meta Class的方法列表中查找。</li>
</ul>

<p>而Meta Class也是一个Class，它跟其他Class一样有自己的isa和super_class指针。
具体的如图所示：</p>
<figure>
	<img src="/images/IOS/record/yymodel/object_struct.jpeg" /> 
</figure>

<ul>
  <li>每个Class都有一个isa指针指向一个唯一的Meta Class</li>
  <li>每一个Meta Class的isa指针都指向嘴上层的Meta Class</li>
  <li>最上层的Meta Class的super class指向自己，形成一个环路</li>
  <li>每一个Meta Class的super class指针指向它原本Class的 Super Class的Meta Class。但是最上层的Meta Class的 Super Class指向NSObject Class本身</li>
  <li>最上层的NSObject Class的super Class指向nil。</li>
</ul>

<h4 id="yymodel">华丽丽的分割线 其实上面说的根本没有卵用 我们来看看YYModel的序列化过程</h4>
<p>序列化的步骤一般都是：</p>

<ul>
  <li>遍历类定义中的所有属性，储存在一个字典中。</li>
  <li>找到所有属性对应的set和get方法，储存在一个字典里</li>
  <li>确认json字典里的key和类定义中属性的映射关系，一般来说json字典里的key的名字就是我们类定义中的属性名，所以如果不需要定制化，这一步是可以省略的</li>
  <li>解析需要序列化的字典，根据key和value的类型判断需要序列化的对象类型</li>
  <li>根据该对象类型的属性和方法字典来实例化一个对象，并设置好值，这个就是我们要得结果了</li>
</ul>

<p>YYModel的序列化过程也是这样，首先有一个YYClassInfo对象来储存class信息：</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="p">+</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">classInfoWithClass:</span><span class="p">(</span><span class="kt">Class</span><span class="p">)</span><span class="nv">cls</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls</span><span class="p">)</span> <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">CFMutableDictionaryRef</span> <span class="n">classCache</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">CFMutableDictionaryRef</span> <span class="n">metaCache</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">dispatch_once_t</span> <span class="n">onceToken</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">OSSpinLock</span> <span class="n">lock</span><span class="p">;</span>
    <span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onceToken</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">classCache</span> <span class="o">=</span> <span class="n">CFDictionaryCreateMutable</span><span class="p">(</span><span class="n">CFAllocatorGetDefault</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kCFTypeDictionaryKeyCallBacks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kCFTypeDictionaryValueCallBacks</span><span class="p">);</span>
        <span class="n">metaCache</span> <span class="o">=</span> <span class="n">CFDictionaryCreateMutable</span><span class="p">(</span><span class="n">CFAllocatorGetDefault</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kCFTypeDictionaryKeyCallBacks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kCFTypeDictionaryValueCallBacks</span><span class="p">);</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="n">OS_SPINLOCK_INIT</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="n">OSSpinLockLock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
    <span class="n">YYClassInfo</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">CFDictionaryGetValue</span><span class="p">(</span><span class="n">class_isMetaClass</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="o">?</span> <span class="nl">metaCache</span> <span class="p">:</span> <span class="n">classCache</span><span class="p">,</span> <span class="p">(</span><span class="k">__bridge</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">cls</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">_needUpdate</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">info</span> <span class="n">_update</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">OSSpinLockUnlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[[</span><span class="n">YYClassInfo</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithClass</span><span class="p">:</span><span class="n">cls</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">OSSpinLockLock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
            <span class="n">CFDictionarySetValue</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">isMeta</span> <span class="o">?</span> <span class="nl">metaCache</span> <span class="p">:</span> <span class="n">classCache</span><span class="p">,</span> <span class="p">(</span><span class="k">__bridge</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">cls</span><span class="p">),</span> <span class="p">(</span><span class="k">__bridge</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="p">));</span>
            <span class="n">OSSpinLockUnlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">info</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>可以看到所有出现的class定义都会储存在一个全局静态字典classCache和metaCache中。我们再看一个YYClassInfo包含那些数据呢：</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="cm">/**</span>
<span class="cm"> Class information for a class.</span>
<span class="cm"> */</span>
<span class="k">@interface</span> <span class="nc">YYClassInfo</span> : <span class="bp">NSObject</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="kt">Class</span> <span class="n">cls</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="kt">Class</span> <span class="n">superCls</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="kt">Class</span> <span class="n">metaCls</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">isMeta</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">YYClassInfo</span> <span class="o">*</span><span class="n">superClassInfo</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSDictionary</span> <span class="o">*</span><span class="n">ivarInfos</span><span class="p">;</span>     <span class="c1">//&lt; key:NSString(ivar),     value:YYClassIvarInfo</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSDictionary</span> <span class="o">*</span><span class="n">methodInfos</span><span class="p">;</span>   <span class="c1">//&lt; key:NSString(selector), value:YYClassMethodInfo</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSDictionary</span> <span class="o">*</span><span class="n">propertyInfos</span><span class="p">;</span> <span class="c1">//&lt; key:NSString(property), value:YYClassPropertyInfo</span>
<span class="k">@end</span>
<span class="cm">/**</span>
<span class="cm"> Instance variable information.</span>
<span class="cm"> */</span>
<span class="k">@interface</span> <span class="nc">YYClassIvarInfo</span> : <span class="bp">NSObject</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">Ivar</span> <span class="n">ivar</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span> <span class="c1">//&lt; Ivar&#39;s name</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="kt">ptrdiff_t</span> <span class="n">offset</span><span class="p">;</span> <span class="c1">//&lt; Ivar&#39;s offset</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">typeEncoding</span><span class="p">;</span> <span class="c1">//&lt; Ivar&#39;s type encoding</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">YYEncodingType</span> <span class="n">type</span><span class="p">;</span> <span class="c1">//&lt; Ivar&#39;s type </span>
<span class="k">@end</span>
<span class="cm">/**</span>
<span class="cm"> Method information.</span>
<span class="cm"> */</span>
<span class="k">@interface</span> <span class="nc">YYClassMethodInfo</span> : <span class="bp">NSObject</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">Method</span> <span class="n">method</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span> <span class="c1">//&lt; method name</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="kt">SEL</span> <span class="n">sel</span><span class="p">;</span> <span class="c1">//&lt; method&#39;s selector</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="kt">IMP</span> <span class="n">imp</span><span class="p">;</span> <span class="c1">//&lt; method&#39;s implementation</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">typeEncoding</span><span class="p">;</span> <span class="c1">//&lt; method&#39;s parameter and return types</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">returnTypeEncoding</span><span class="p">;</span> <span class="c1">//&lt; return value&#39;s type</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSArray</span> <span class="o">*</span><span class="n">argumentTypeEncodings</span><span class="p">;</span> <span class="c1">//&lt; array of arguments&#39; type</span>
<span class="k">@end</span>
<span class="cm">/**</span>
<span class="cm"> Property information.</span>
<span class="cm"> */</span>
<span class="k">@interface</span> <span class="nc">YYClassPropertyInfo</span> : <span class="bp">NSObject</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="kt">objc_property_t</span> <span class="n">property</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span> <span class="c1">//&lt; property&#39;s name</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">YYEncodingType</span> <span class="n">type</span><span class="p">;</span> <span class="c1">//&lt; property&#39;s type</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">typeEncoding</span><span class="p">;</span> <span class="c1">//&lt; property&#39;s encoding value</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">ivarName</span><span class="p">;</span> <span class="c1">//&lt; property&#39;s ivar name</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="kt">Class</span> <span class="n">cls</span><span class="p">;</span> <span class="c1">//&lt; may be nil</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="k">getter</span><span class="p">;</span> <span class="c1">//&lt; getter (nonnull)</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="k">setter</span><span class="p">;</span> <span class="c1">//&lt; setter (nonnull)</span>
<span class="k">@end</span></code></pre></div>

<p>我只截取了属性定义的部分。YYClassInfo储存了一个类里面所有的属性和方法字典，并保存了_cls、_superCls和_metaCls的签名。
主要使用了OC的class_copyMethodList、class_copyPropertyList和class_copyIvarList方法，动过cls签名获取了类的信息。
当然，说起来好像很简单，实际需要你对OC的底层非常了解，知道objc_method、objc_ivar和objc_property的定义，知道Type Encodings和Declared Properties这些信息，才能真的解析出我们需要的信息。
这里我找到了OC里面关于上面那些结构体的定义：</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="err">类的数据结构</span>

<span class="kt">Class</span><span class="p">(</span><span class="err">指针</span><span class="p">)</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">objc_class</span> <span class="o">*</span><span class="kt">Class</span><span class="p">;</span>
       
<span class="cm">/*</span>
<span class="cm">  这是由编译器为每个类产生的数据结构,这个结构定义了一个类.这个结构是通过编译器在执行时产生,在运行时发送消息时使用.因此,一些成员改变了类型.编译器产生&quot;char* const&quot;类型的字符串指针替代了下面的成员变量&quot;super_class&quot;</span>
<span class="cm">*/</span>
<span class="k">struct</span> <span class="n">objc_class</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">objc_class</span><span class="o">*</span>  <span class="n">class_pointer</span><span class="p">;</span>    <span class="cm">/* 指向元类的指针. */</span>
  <span class="k">struct</span> <span class="n">objc_class</span><span class="o">*</span>  <span class="n">super_class</span><span class="p">;</span>      <span class="cm">/* 指向父类的指针. 对于NSObject来说是NULL.*/</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span>         <span class="n">name</span><span class="p">;</span>             <span class="cm">/* 类的名称. */</span>
  <span class="kt">long</span>                <span class="n">version</span><span class="p">;</span>          <span class="cm">/* 未知. */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span>       <span class="n">info</span><span class="p">;</span>             <span class="cm">/* 比特蒙板.  参考下面类的蒙板定义. */</span>
  <span class="kt">long</span>                <span class="n">instance_size</span><span class="p">;</span>    <span class="cm">/* 类的字节数.包含类的定义和所有父类的定义 */</span>
<span class="cp">#ifdef _WIN64</span>
  <span class="kt">long</span> <span class="n">pad</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="k">struct</span> <span class="n">objc_ivar_list</span><span class="o">*</span> <span class="n">ivars</span><span class="p">;</span>         <span class="cm">/* 指向类中定义的实例变量的列表结构. NULL代表没有实例变量.不包括父类的变量. */</span>
  <span class="k">struct</span> <span class="n">objc_method_list</span><span class="o">*</span>  <span class="n">methods</span><span class="p">;</span>    <span class="cm">/* 链接类中定义的实例方法. */</span>
  <span class="k">struct</span> <span class="n">sarray</span> <span class="o">*</span>    <span class="n">dtable</span><span class="p">;</span>            <span class="cm">/* 指向实例方法分配表. */</span>
  <span class="k">struct</span> <span class="n">objc_class</span><span class="o">*</span> <span class="n">subclass_list</span><span class="p">;</span>     <span class="cm">/* 父类列表 */</span>
  <span class="k">struct</span> <span class="n">objc_class</span><span class="o">*</span> <span class="n">sibling_class</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">objc_protocol_list</span> <span class="o">*</span><span class="n">protocols</span><span class="p">;</span> <span class="cm">/* 要实现的原型列表 */</span>
  <span class="kt">void</span><span class="o">*</span> <span class="n">gc_object_type</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">Method</span><span class="p">(</span><span class="err">指针</span><span class="p">)</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">objc_method</span> <span class="o">*</span><span class="n">Method</span><span class="p">;</span>
       
<span class="cm">/* 编译器依据类中定义的方法为该类产生一个或更多这种这种结构.</span>
<span class="cm">    一个类的实现可以分散在一个文件中不同部分,同时类别可以分散在不同的模块中.为了处理这个问题,使用一个单独的方法链表 */</span>
<span class="k">struct</span> <span class="n">objc_method</span>
<span class="p">{</span>
  <span class="kt">SEL</span>         <span class="n">method_name</span><span class="p">;</span>  <span class="cm">/* 这个变量就是方法的名称.编译器使用在这里使用一个`char*`,当一个方法被注册,名称在运行时被使用真正的SEL替代  */</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">method_types</span><span class="p">;</span> <span class="cm">/* 描述方法的参数列表. 在运行时注册选择器时使用.那时候方法名就会包含方法的参数列表.*/</span>
  <span class="kt">IMP</span>         <span class="n">method_imp</span><span class="p">;</span>   <span class="cm">/* 方法执行时候的地址. */</span>
<span class="p">};</span>
<span class="n">Ivar</span><span class="p">(</span><span class="err">指针</span><span class="p">)</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">objc_ivar</span> <span class="o">*</span><span class="n">Ivar</span><span class="p">;</span>
       
<span class="cm">/* 编译器依据类中定义的实例变量为该类产生一个或更多这种这种结构  */</span>
<span class="k">struct</span> <span class="n">objc_ivar</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ivar_name</span><span class="p">;</span>  <span class="cm">/* 类中定义的变量名. */</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ivar_type</span><span class="p">;</span>  <span class="cm">/* 描述变量的类型.调试时非常有用. */</span>
  <span class="kt">int</span>        <span class="n">ivar_offset</span><span class="p">;</span> <span class="cm">/* 实例结构的基地址偏移字节 */</span>
<span class="p">};</span>
<span class="n">Category</span><span class="p">(</span><span class="err">指针</span><span class="p">)</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">objc_category</span> <span class="o">*</span><span class="n">Category</span><span class="p">;</span>
       
<span class="cm">/* 编译器为每个类别产生一个这样的结构.一个类可以具有多个类别同时既包括实例方法,也可以包括类方法*/</span>
<span class="k">struct</span> <span class="n">objc_category</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span>   <span class="n">category_name</span><span class="p">;</span>                <span class="cm">/* 类别名.定义在类别后面的括号内*/</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span>   <span class="n">class_name</span><span class="p">;</span>                   <span class="cm">/* 类名 */</span>
  <span class="k">struct</span> <span class="n">objc_method_list</span>  <span class="o">*</span><span class="n">instance_methods</span><span class="p">;</span> <span class="cm">/* 链接类中定义的实例方法. NULL表示没有实例方法. */</span>
  <span class="k">struct</span> <span class="n">objc_method_list</span> <span class="o">*</span><span class="n">class_methods</span><span class="p">;</span>     <span class="cm">/* 链接类中定义的类方法. NULL表示没有类方法. */</span>
  <span class="k">struct</span> <span class="n">objc_protocol_list</span> <span class="o">*</span><span class="n">protocols</span><span class="p">;</span>       <span class="cm">/* 遵循的协议表  */</span>
<span class="p">};</span>
<span class="kt">objc_property_t</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">objc_property</span> <span class="o">*</span><span class="kt">objc_property_t</span><span class="p">;</span>
<span class="kt">IMP</span>

<span class="kt">id</span> <span class="p">(</span><span class="o">*</span><span class="kt">IMP</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="p">...)</span>
<span class="kt">SEL</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">objc_selector</span> <span class="o">*</span><span class="kt">SEL</span><span class="p">;</span>
       
<span class="k">struct</span> <span class="n">objc_selector</span>
<span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">sel_id</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sel_types</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">objc_method_list</span>

<span class="k">struct</span> <span class="n">objc_method_list</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">objc_method_list</span><span class="o">*</span>  <span class="n">method_next</span><span class="p">;</span> <span class="cm">/* 这个变量用来链接另一个单独的方法链表 */</span>
  <span class="kt">int</span>            <span class="n">method_count</span><span class="p">;</span>            <span class="cm">/* 结构中定义的方法数量 */</span>
  <span class="k">struct</span> <span class="n">objc_method</span> <span class="n">method_list</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>      <span class="cm">/* 可变长度的结构 */</span>
<span class="p">};</span>
<span class="n">objc_cache</span>

<span class="k">struct</span> <span class="n">objc_cache</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">occupied</span><span class="p">;</span>
    <span class="n">Method</span> <span class="n">buckets</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>
<span class="n">objc_protocol_list</span>

<span class="k">struct</span> <span class="n">objc_protocol_list</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">objc_protocol_list</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">objc_protocol</span> <span class="o">*</span><span class="n">list</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>
<span class="err">实例的数据结构</span>

<span class="kt">id</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">objc_object</span> <span class="o">*</span><span class="kt">id</span><span class="p">;</span>
<span class="n">objc_object</span>

<span class="k">struct</span> <span class="n">objc_object</span>
<span class="p">{</span>
  <span class="cm">/* 类的指针是对象相关的类.如果是一个类对象, 这个指针指向元类.</span>
<span class="cm">  Class isa;</span>
<span class="cm">};</span>
<span class="cm">objc_super</span>

<span class="cm">struct objc_super</span>
<span class="cm">{</span>
<span class="cm">  id    self;        /* 消息的接受者  */</span>
  <span class="kt">Class</span> <span class="n">super_class</span><span class="p">;</span> <span class="cm">/* 接受者的父类  */</span>
<span class="p">};</span></code></pre></div>

<p>有了上面这些信息相信所有人都知道作者的代码都在干嘛了，具体不表。反正到此为止，我们已经有了class的定义。
理论上下一步就可以解析了，但是作者额外多了一步，定制了映射关系。出现了一个新的class属性映射关系类的定义：</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="c1">//A class info in object model.</span>
<span class="k">@interface</span> <span class="nc">_YYModelMeta</span> : <span class="bp">NSObject</span> <span class="p">{</span>
<span class="k">@public</span>
    <span class="c1">// Key:mapped key and key path, Value:_YYModelPropertyInfo.</span>
    <span class="bp">NSDictionary</span> <span class="o">*</span><span class="n">_mapper</span><span class="p">;</span>
    <span class="c1">// Array&lt;_YYModelPropertyInfo&gt;, all property meta of this model.</span>
    <span class="bp">NSArray</span> <span class="o">*</span><span class="n">_allPropertyMetas</span><span class="p">;</span>
    <span class="c1">// Array&lt;_YYModelPropertyInfo&gt;, property meta which is mapped to a key path.</span>
    <span class="bp">NSArray</span> <span class="o">*</span><span class="n">_keyPathPropertyMetas</span><span class="p">;</span>
    <span class="c1">// The number of mapped key (and key path), same to _mapper.count.</span>
    <span class="bp">NSUInteger</span> <span class="n">_keyMappedCount</span><span class="p">;</span>
    <span class="c1">// Model class type.</span>
    <span class="n">YYEncodingNSType</span> <span class="n">_nsType</span><span class="p">;</span>
    
    <span class="kt">BOOL</span> <span class="n">_hasCustomTransformFromDictonary</span><span class="p">;</span>
    <span class="kt">BOOL</span> <span class="n">_hasCustomTransformToDictionary</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">@end</span></code></pre></div>

<p>上面的YYClassInfo更像是一个抽象的模板，只是告诉我们类里面有这些属性和方法，没有告诉我们怎么去解析。_YYModelMeta这个类就是告诉我们怎么去解析的。
同样的所有_YYModelMeta都缓存在了一个全局静态字典里面。_YYModelMeta通过YYClassInfo的信息来实例化：</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="p">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">initWithClass:</span><span class="p">(</span><span class="kt">Class</span><span class="p">)</span><span class="nv">cls</span> <span class="p">{</span>
    <span class="n">YYClassInfo</span> <span class="o">*</span><span class="n">classInfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">YYClassInfo</span> <span class="nl">classInfoWithClass</span><span class="p">:</span><span class="n">cls</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">classInfo</span><span class="p">)</span> <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">];</span>
    
    <span class="c1">// Get black list</span>
    <span class="bp">NSSet</span> <span class="o">*</span><span class="n">blacklist</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">cls</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">modelPropertyBlacklist</span><span class="p">)])</span> <span class="p">{</span>
        <span class="bp">NSArray</span> <span class="o">*</span><span class="n">properties</span> <span class="o">=</span> <span class="p">[(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">YYModel</span><span class="o">&gt;</span><span class="p">)</span><span class="n">cls</span> <span class="n">modelPropertyBlacklist</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">properties</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">blacklist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSSet</span> <span class="nl">setWithArray</span><span class="p">:</span><span class="n">properties</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// Get white list</span>
    <span class="bp">NSSet</span> <span class="o">*</span><span class="n">whitelist</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">cls</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">modelPropertyWhitelist</span><span class="p">)])</span> <span class="p">{</span>
        <span class="bp">NSArray</span> <span class="o">*</span><span class="n">properties</span> <span class="o">=</span> <span class="p">[(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">YYModel</span><span class="o">&gt;</span><span class="p">)</span><span class="n">cls</span> <span class="n">modelPropertyWhitelist</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">properties</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">whitelist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSSet</span> <span class="nl">setWithArray</span><span class="p">:</span><span class="n">properties</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// Get container property&#39;s generic class</span>
    <span class="bp">NSDictionary</span> <span class="o">*</span><span class="n">genericMapper</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">cls</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">modelContainerPropertyGenericClass</span><span class="p">)])</span> <span class="p">{</span>
        <span class="n">genericMapper</span> <span class="o">=</span> <span class="p">[(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">YYModel</span><span class="o">&gt;</span><span class="p">)</span><span class="n">cls</span> <span class="n">modelContainerPropertyGenericClass</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">genericMapper</span><span class="p">)</span> <span class="p">{</span>
            <span class="bp">NSMutableDictionary</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">genericMapper</span><span class="p">.</span><span class="n">mutableCopy</span><span class="p">;</span>
            <span class="p">[</span><span class="n">genericMapper</span> <span class="nl">enumerateKeysAndObjectsUsingBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">id</span> <span class="n">key</span><span class="p">,</span> <span class="kt">id</span> <span class="n">obj</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">key</span> <span class="nl">isKindOfClass</span><span class="p">:[</span><span class="bp">NSString</span> <span class="k">class</span><span class="p">]])</span> <span class="k">return</span><span class="p">;</span>
                <span class="kt">Class</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">object_getClass</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meta</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">class_isMetaClass</span><span class="p">(</span><span class="n">meta</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">([</span><span class="n">obj</span> <span class="nl">isKindOfClass</span><span class="p">:[</span><span class="bp">NSString</span> <span class="k">class</span><span class="p">]])</span> <span class="p">{</span>
                    <span class="kt">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">NSClassFromString</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">tmp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}];</span>
            <span class="n">genericMapper</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// Create all property metas.</span>
    <span class="bp">NSMutableDictionary</span> <span class="o">*</span><span class="n">allPropertyMetas</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableDictionary</span> <span class="k">new</span><span class="p">];</span>
    <span class="n">YYClassInfo</span> <span class="o">*</span><span class="n">curClassInfo</span> <span class="o">=</span> <span class="n">classInfo</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">curClassInfo</span> <span class="o">&amp;&amp;</span> <span class="n">curClassInfo</span><span class="p">.</span><span class="n">superCls</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// recursive parse super class, but ignore root class (NSObject/NSProxy)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">YYClassPropertyInfo</span> <span class="o">*</span><span class="n">propertyInfo</span> <span class="k">in</span> <span class="n">curClassInfo</span><span class="p">.</span><span class="n">propertyInfos</span><span class="p">.</span><span class="n">allValues</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">propertyInfo</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">blacklist</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="n">blacklist</span> <span class="nl">containsObject</span><span class="p">:</span><span class="n">propertyInfo</span><span class="p">.</span><span class="n">name</span><span class="p">])</span> <span class="k">continue</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">whitelist</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">[</span><span class="n">whitelist</span> <span class="nl">containsObject</span><span class="p">:</span><span class="n">propertyInfo</span><span class="p">.</span><span class="n">name</span><span class="p">])</span> <span class="k">continue</span><span class="p">;</span>
            <span class="n">_YYModelPropertyMeta</span> <span class="o">*</span><span class="n">meta</span> <span class="o">=</span> <span class="p">[</span><span class="n">_YYModelPropertyMeta</span> <span class="nl">metaWithClassInfo</span><span class="p">:</span><span class="n">classInfo</span>
                                                                    <span class="nl">propertyInfo</span><span class="p">:</span><span class="n">propertyInfo</span>
                                                                         <span class="nl">generic</span><span class="p">:</span><span class="n">genericMapper</span><span class="p">[</span><span class="n">propertyInfo</span><span class="p">.</span><span class="n">name</span><span class="p">]];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meta</span> <span class="o">||</span> <span class="o">!</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">_name</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">_getter</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">_setter</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">allPropertyMetas</span><span class="p">[</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">_name</span><span class="p">])</span> <span class="k">continue</span><span class="p">;</span>
            <span class="n">allPropertyMetas</span><span class="p">[</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">curClassInfo</span> <span class="o">=</span> <span class="n">curClassInfo</span><span class="p">.</span><span class="n">superClassInfo</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">allPropertyMetas</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="n">_allPropertyMetas</span> <span class="o">=</span> <span class="n">allPropertyMetas</span><span class="p">.</span><span class="n">allValues</span><span class="p">.</span><span class="k">copy</span><span class="p">;</span>
    
    <span class="c1">// create mapper</span>
    <span class="bp">NSMutableDictionary</span> <span class="o">*</span><span class="n">mapper</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableDictionary</span> <span class="k">new</span><span class="p">];</span>
    <span class="bp">NSMutableArray</span> <span class="o">*</span><span class="n">keyPathPropertyMetas</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableArray</span> <span class="k">new</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">cls</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">modelCustomPropertyMapper</span><span class="p">)])</span> <span class="p">{</span>
        <span class="bp">NSDictionary</span> <span class="o">*</span><span class="n">customMapper</span> <span class="o">=</span> <span class="p">[(</span><span class="kt">id</span> <span class="o">&lt;</span><span class="n">YYModel</span><span class="o">&gt;</span><span class="p">)</span><span class="n">cls</span> <span class="n">modelCustomPropertyMapper</span><span class="p">];</span>
        <span class="p">[</span><span class="n">customMapper</span> <span class="nl">enumerateKeysAndObjectsUsingBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="n">propertyName</span><span class="p">,</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">mappedToKey</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_YYModelPropertyMeta</span> <span class="o">*</span><span class="n">propertyMeta</span> <span class="o">=</span> <span class="n">allPropertyMetas</span><span class="p">[</span><span class="n">propertyName</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">propertyMeta</span><span class="p">)</span> <span class="p">{</span>
                <span class="bp">NSArray</span> <span class="o">*</span><span class="n">keyPath</span> <span class="o">=</span> <span class="p">[</span><span class="n">mappedToKey</span> <span class="nl">componentsSeparatedByString</span><span class="p">:</span><span class="s">@&quot;.&quot;</span><span class="p">];</span>
                <span class="n">propertyMeta</span><span class="o">-&gt;</span><span class="n">_mappedToKey</span> <span class="o">=</span> <span class="n">mappedToKey</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">keyPath</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">propertyMeta</span><span class="o">-&gt;</span><span class="n">_mappedToKeyPath</span> <span class="o">=</span> <span class="n">keyPath</span><span class="p">;</span>
                    <span class="p">[</span><span class="n">keyPathPropertyMetas</span> <span class="nl">addObject</span><span class="p">:</span><span class="n">propertyMeta</span><span class="p">];</span>
                <span class="p">}</span>
                <span class="p">[</span><span class="n">allPropertyMetas</span> <span class="nl">removeObjectForKey</span><span class="p">:</span><span class="n">propertyName</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mapper</span><span class="p">[</span><span class="n">mappedToKey</span><span class="p">])</span> <span class="p">{</span>
                    <span class="p">((</span><span class="n">_YYModelPropertyMeta</span> <span class="o">*</span><span class="p">)</span><span class="n">mapper</span><span class="p">[</span><span class="n">mappedToKey</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">_next</span> <span class="o">=</span> <span class="n">propertyMeta</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">mapper</span><span class="p">[</span><span class="n">mappedToKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">propertyMeta</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}];</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">allPropertyMetas</span> <span class="nl">enumerateKeysAndObjectsUsingBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">_YYModelPropertyMeta</span> <span class="o">*</span><span class="n">propertyMeta</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">propertyMeta</span><span class="o">-&gt;</span><span class="n">_mappedToKey</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mapper</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="p">{</span>
            <span class="p">((</span><span class="n">_YYModelPropertyMeta</span> <span class="o">*</span><span class="p">)</span><span class="n">mapper</span><span class="p">[</span><span class="n">name</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">_next</span> <span class="o">=</span> <span class="n">propertyMeta</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">mapper</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">propertyMeta</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">mapper</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="n">_mapper</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">keyPathPropertyMetas</span><span class="p">)</span> <span class="n">_keyPathPropertyMetas</span> <span class="o">=</span> <span class="n">keyPathPropertyMetas</span><span class="p">;</span>
    <span class="n">_keyMappedCount</span> <span class="o">=</span> <span class="n">_allPropertyMetas</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
    <span class="n">_nsType</span> <span class="o">=</span> <span class="n">YYClassGetNSType</span><span class="p">(</span><span class="n">cls</span><span class="p">);</span>
    <span class="n">_hasCustomTransformFromDictonary</span> <span class="o">=</span> <span class="p">([</span><span class="n">cls</span> <span class="nl">instancesRespondToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">modelCustomTransformFromDictionary</span><span class="p">:)]);</span>
    <span class="n">_hasCustomTransformToDictionary</span> <span class="o">=</span> <span class="p">([</span><span class="n">cls</span> <span class="nl">instancesRespondToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">modelCustomTransformToDictionary</span><span class="p">:)]);</span>
    
    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>翻译成伪代码就是：</p>

<ul>
  <li>1.获取属性的白名单、黑名单和解析的key-value映射表。</li>
  <li>2.根据这些信息生成Json字典里的key和类定义中的映射关系，保存在一个map中。</li>
</ul>

<p>白名单的作用就是如果存在白名单则在实例化的时候只管白名单里面的属性，_YYModelMeta里面也只保存白名单里面的属性映射。黑名单的作用就是过滤掉黑名单里面的属性，其他的属性映射都保存。
当然一般简单地序列化是不需要这些个定制化的东西的，作者还额外实现了一些特殊属性的特殊映射关系，比如一些类定义里面的字典或者数组该如何实例化，我们就需要知道这些数组和字典里面储存的是
什么类型的value，作者通过modelContainerPropertyGenericClass这个接口，让用户自己来设置。作者还额外提供了一个接口modelCustomPropertyMapper，顾名思义，某些属性的名字跟
json字典中的key不一样或者本身就需要映射到跟属性不同名的key上，用户就可以通过这个接口返回一个字典来设置：</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="cm">/**</span>
<span class="cm"> Custom property mapper.</span>
<span class="cm"> </span>
<span class="cm"> @discussion If the key in JSON/Dictionary does not match to the model&#39;s property name,</span>
<span class="cm"> implements this method and returns the additional mapper.</span>
<span class="cm"> </span>
<span class="cm"> Example:</span>
<span class="cm">    </span>
<span class="cm">    json: </span>
<span class="cm">        {</span>
<span class="cm">            &quot;n&quot;:&quot;Harry Pottery&quot;,</span>
<span class="cm">            &quot;p&quot;: 256,</span>
<span class="cm">            &quot;ext&quot; : {</span>
<span class="cm">                &quot;desc&quot; : &quot;A book written by J.K.Rowing.&quot;</span>
<span class="cm">            }</span>
<span class="cm">        }</span>
<span class="cm"> </span>
<span class="cm">    model:</span>
<span class="cm">        @interface YYBook : NSObject</span>
<span class="cm">        @property NSString *name;</span>
<span class="cm">        @property NSInteger page;</span>
<span class="cm">        @property NSString *desc;</span>
<span class="cm">        @end</span>
<span class="cm"> </span>
<span class="cm">        @implementation YYBook</span>
<span class="cm">        + (NSDictionary *)modelCustomPropertyMapper {</span>
<span class="cm">            return @{@&quot;name&quot; : @&quot;n&quot;,</span>
<span class="cm">                     @&quot;page&quot; : @&quot;p&quot;,</span>
<span class="cm">                     @&quot;desc&quot; : @&quot;ext.desc&quot;};</span>
<span class="cm">        }</span>
<span class="cm">        @end</span>
<span class="cm"> </span>
<span class="cm"> @return A custom mapper for properties.</span>
<span class="cm"> */</span>
<span class="p">+</span> <span class="p">(</span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nf">modelCustomPropertyMapper</span><span class="p">;</span></code></pre></div>

<p>在生成映射表的时候有个问题，那就是一个key只能对应一个value，加入类A中的属性B、C都要对应到json字典中的KeyB字段，则这个映射表是没办法实现的，
这也是为什么作者在_YYModelPropertyMeta的定义中添加_YYModelPropertyMeta *_next;这个属性。_YYModelPropertyMeta的完整定义如下:</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="c1">// A property info in object model.</span>
<span class="k">@interface</span> <span class="nc">_YYModelPropertyMeta</span> : <span class="bp">NSObject</span> <span class="p">{</span>
<span class="k">@public</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">_name</span><span class="p">;</span>             <span class="c1">//&lt; property&#39;s name</span>
    <span class="n">YYEncodingType</span> <span class="n">_type</span><span class="p">;</span>        <span class="c1">//&lt; property&#39;s type</span>
    <span class="n">YYEncodingNSType</span> <span class="n">_nsType</span><span class="p">;</span>    <span class="c1">//&lt; property&#39;s Foundation type</span>
    <span class="kt">BOOL</span> <span class="n">_isCNumber</span><span class="p">;</span>             <span class="c1">//&lt; is c number type</span>
    <span class="kt">Class</span> <span class="n">_cls</span><span class="p">;</span>                  <span class="c1">//&lt; property&#39;s class, or nil</span>
    <span class="kt">Class</span> <span class="n">_genericCls</span><span class="p">;</span>           <span class="c1">//&lt; container&#39;s generic class, or nil if threr&#39;s no generic class</span>
    <span class="kt">SEL</span> <span class="n">_getter</span><span class="p">;</span>                 <span class="c1">//&lt; getter, or nil if the instances cannot respond</span>
    <span class="kt">SEL</span> <span class="n">_setter</span><span class="p">;</span>                 <span class="c1">//&lt; setter, or nil if the instances cannot respond</span>
    
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">_mappedToKey</span><span class="p">;</span>      <span class="c1">//&lt; the key mapped to</span>
    <span class="bp">NSArray</span> <span class="o">*</span><span class="n">_mappedToKeyPath</span><span class="p">;</span>   <span class="c1">//&lt; the key path mapped to (nil if the name is not key path)</span>
    <span class="n">_YYModelPropertyMeta</span> <span class="o">*</span><span class="n">_next</span><span class="p">;</span> <span class="c1">//&lt; next meta if there are multiple properties mapped to the same key.</span>
<span class="p">}</span>
<span class="k">@end</span></code></pre></div>

<p>我们已经知道了YYClassInfo和_YYModelMeta的关系，那么_YYModelPropertyMeta和YYClassPropertyInfo是什么关系呢？我们看到YYClassPropertyInfo中
保存的是属性的原始模板信息，而且代码里有一段：</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="n">_YYModelPropertyMeta</span> <span class="o">*</span><span class="n">meta</span> <span class="o">=</span> <span class="p">[</span><span class="n">_YYModelPropertyMeta</span> <span class="nl">metaWithClassInfo</span><span class="p">:</span><span class="n">classInfo</span>
                                                                    <span class="nl">propertyInfo</span><span class="p">:</span><span class="n">propertyInfo</span>
                                                                         <span class="nl">generic</span><span class="p">:</span><span class="n">genericMapper</span><span class="p">[</span><span class="n">propertyInfo</span><span class="p">.</span><span class="n">name</span><span class="p">]];</span></code></pre></div>

<p>可以看到_YYModelPropertyMeta是通过YYClassPropertyInfo模板生成的，_YYModelPropertyMeta里面保存的信息相对于YYClassPropertyInfo来说更少也更针对，
_YYModelPropertyMeta把YYClassPropertyInfo中的get和set方法名转化成了SEL类型的对象，我学OC时间不长，也不知道该怎么称呼SEL对象，叫方法选择器？Whatever。。。
习惯了C++的朋友直接理解成函数地址也行，习惯了Window的消息分发机制的也可以理解为接受消息的对象，反正得到这个之后想要设置属性的值就只需要调用OC的发送消息接口就行了，比如下面的代码：</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="cm">/**</span>
<span class="cm"> Set number to property.</span>
<span class="cm"> @discussion Caller should hold strong reference to the parameters before this function returns.</span>
<span class="cm"> @param model Should not be nil.</span>
<span class="cm"> @param num   Can be nil.</span>
<span class="cm"> @param meta  Should not be nil, meta.isCNumber should be YES, meta.setter should not be nil.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">force_inline</span> <span class="kt">void</span> <span class="nf">ModelSetNumberToProperty</span><span class="p">(</span><span class="n">__unsafe_unretained</span> <span class="kt">id</span> <span class="n">model</span><span class="p">,</span>
                                                  <span class="n">__unsafe_unretained</span> <span class="bp">NSNumber</span> <span class="o">*</span><span class="n">num</span><span class="p">,</span>
                                                  <span class="n">__unsafe_unretained</span> <span class="n">_YYModelPropertyMeta</span> <span class="o">*</span><span class="n">meta</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">_type</span> <span class="o">&amp;</span> <span class="n">YYEncodingTypeMask</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">YYEncodingTypeBool</span><span class="p">:</span> <span class="p">{</span>
            <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="kt">bool</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">objc_msgSend</span><span class="p">)((</span><span class="kt">id</span><span class="p">)</span><span class="n">model</span><span class="p">,</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">_setter</span><span class="p">,</span> <span class="n">num</span><span class="p">.</span><span class="n">boolValue</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">YYEncodingTypeInt8</span><span class="p">:</span> <span class="p">{</span>
            <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="kt">int8_t</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">objc_msgSend</span><span class="p">)((</span><span class="kt">id</span><span class="p">)</span><span class="n">model</span><span class="p">,</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">_setter</span><span class="p">,</span> <span class="p">(</span><span class="kt">int8_t</span><span class="p">)</span><span class="n">num</span><span class="p">.</span><span class="n">charValue</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">YYEncodingTypeUInt8</span><span class="p">:</span> <span class="p">{</span>
            <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">objc_msgSend</span><span class="p">)((</span><span class="kt">id</span><span class="p">)</span><span class="n">model</span><span class="p">,</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">_setter</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">num</span><span class="p">.</span><span class="n">unsignedCharValue</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">YYEncodingTypeInt16</span><span class="p">:</span> <span class="p">{</span>
            <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="kt">int16_t</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">objc_msgSend</span><span class="p">)((</span><span class="kt">id</span><span class="p">)</span><span class="n">model</span><span class="p">,</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">_setter</span><span class="p">,</span> <span class="p">(</span><span class="kt">int16_t</span><span class="p">)</span><span class="n">num</span><span class="p">.</span><span class="n">shortValue</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">YYEncodingTypeUInt16</span><span class="p">:</span> <span class="p">{</span>
            <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="kt">uint16_t</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">objc_msgSend</span><span class="p">)((</span><span class="kt">id</span><span class="p">)</span><span class="n">model</span><span class="p">,</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">_setter</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">num</span><span class="p">.</span><span class="n">unsignedShortValue</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">YYEncodingTypeInt32</span><span class="p">:</span> <span class="p">{</span>
            <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="kt">int32_t</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">objc_msgSend</span><span class="p">)((</span><span class="kt">id</span><span class="p">)</span><span class="n">model</span><span class="p">,</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">_setter</span><span class="p">,</span> <span class="p">(</span><span class="kt">int32_t</span><span class="p">)</span><span class="n">num</span><span class="p">.</span><span class="n">intValue</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="nl">YYEncodingTypeUInt32</span><span class="p">:</span> <span class="p">{</span>
            <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">objc_msgSend</span><span class="p">)((</span><span class="kt">id</span><span class="p">)</span><span class="n">model</span><span class="p">,</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">_setter</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">num</span><span class="p">.</span><span class="n">unsignedIntValue</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">YYEncodingTypeInt64</span><span class="p">:</span> <span class="p">{</span>
            <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="kt">int64_t</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">objc_msgSend</span><span class="p">)((</span><span class="kt">id</span><span class="p">)</span><span class="n">model</span><span class="p">,</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">_setter</span><span class="p">,</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">num</span><span class="p">.</span><span class="n">longLongValue</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="nl">YYEncodingTypeUInt64</span><span class="p">:</span> <span class="p">{</span>
            <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="kt">uint64_t</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">objc_msgSend</span><span class="p">)((</span><span class="kt">id</span><span class="p">)</span><span class="n">model</span><span class="p">,</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">_setter</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">num</span><span class="p">.</span><span class="n">unsignedLongLongValue</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">YYEncodingTypeFloat</span><span class="p">:</span> <span class="p">{</span>
            <span class="kt">float</span> <span class="n">f</span> <span class="o">=</span> <span class="n">num</span><span class="p">.</span><span class="n">floatValue</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">||</span> <span class="n">isinf</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="kt">float</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">objc_msgSend</span><span class="p">)((</span><span class="kt">id</span><span class="p">)</span><span class="n">model</span><span class="p">,</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">_setter</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">YYEncodingTypeDouble</span><span class="p">:</span> <span class="p">{</span>
            <span class="kt">double</span> <span class="n">d</span> <span class="o">=</span> <span class="n">num</span><span class="p">.</span><span class="n">floatValue</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">||</span> <span class="n">isinf</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="kt">double</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">objc_msgSend</span><span class="p">)((</span><span class="kt">id</span><span class="p">)</span><span class="n">model</span><span class="p">,</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">_setter</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">YYEncodingTypeLongDouble</span><span class="p">:</span> <span class="p">{</span>
            <span class="kt">double</span> <span class="n">d</span> <span class="o">=</span> <span class="n">num</span><span class="p">.</span><span class="n">floatValue</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">||</span> <span class="n">isinf</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">double</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">objc_msgSend</span><span class="p">)((</span><span class="kt">id</span><span class="p">)</span><span class="n">model</span><span class="p">,</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">_setter</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">double</span><span class="p">)</span><span class="n">d</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>当然_YYModelPropertyMeta跟YYClassPropertyInfo的关系也是一个我们解析时使用的映射表，一个只是属性模板。
到这里我不产生了疑问：YYClassIvarInfo和YYClassMethodInfo对应的映射表呢？YYClassMethodInfo不需要映射，因为他不是属性，不需要赋值，但是YYClassIvarInfo
就不一样了，他表示一个实例变量。但是我们看作者的代码里前前后后好像就没YYClassIvarInfo的事儿。什么才是实例变量呢？一个类里面的实例变量是什么呢？不是属性么？一大串问号。。。。。
我们都知道OC的定义可以像下面这么写：</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="k">@interface</span> <span class="nc">A</span> : <span class="bp">NSObject</span><span class="p">{</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">_name</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="k">@end</span>
<span class="k">@implementation</span> <span class="nc">A</span>
<span class="k">@synthesize</span> <span class="n">name</span> <span class="o">=</span> <span class="n">_name</span><span class="p">;</span>
<span class="k">@end</span></code></pre></div>

<p>或者：</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="k">@interface</span> <span class="nc">A</span> : <span class="bp">NSObject</span><span class="p">{</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="k">@implementation</span> <span class="nc">A</span>
<span class="k">@synthesize</span> <span class="n">name</span><span class="p">;</span>
<span class="k">@end</span></code></pre></div>

<p>或者</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="k">@interface</span> <span class="nc">A</span> : <span class="bp">NSObject</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="k">@implementation</span> <span class="nc">A</span>
<span class="k">@synthesize</span> <span class="n">name</span><span class="p">;</span>
<span class="k">@end</span></code></pre></div>

<p>区别是什么呢？看知乎大神的回答：</p>

<blockquote>
  <p>著作权归作者所有。
商业转载请联系作者获得授权，非商业转载请注明出处。
作者：RefuseBT
链接：http://www.zhihu.com/question/22195598/answer/39593235
来源：知乎</p>
</blockquote>

<blockquote>
  <p>对于方式1，定义最完备。继承时，子类直接访问父类成员变量无需再@synthesize。缺点就是麻烦，重构也麻烦。第二种的问题，在于成员变量没有下划线。这个修改的好处你可能一开始体会不到。其实加下划线最大的好处在于局部变量命名不会冲突。比如你一个成员变量叫name，你的入参也叫name，就会出现覆盖。这个时候简便的办法是对name加冠词，比如aName、anObj，看起来还是挺恶心的。虽然OC也这样干。这个时候如果声明为_name就一劳永逸了，况且编译器还能替你做了这个事。第三种的问题，也是第一种的优势，就是你在父类中可以直接访问成员变量，但是子类中你无法访问，只能通过属性访问到。如果属性还是在.m中声明的，麻烦更多。另外从命名上还兼有第二种的缺陷。
那么最好的写法写法一：
@interface Person : NSObject
{
}
@property (nonatomic, strong) NSString *name;
@end</p>

  <p>@implementation Person
@end
这个适用与一般情况，编译器自动生成成员变量_name，而且写法最简单，不必重复声明。写法二，针对继承情况下，向子类暴露父类成员变量：@interface Person : NSObject
{
	NSString *_name;
}
@property (nonatomic, strong) NSString *name;
@end</p>

  <p>@implementation Person
@synthesize name = _name;
@end
其实@synthesize那条你不写也行，不过我还是喜欢声明完备，毕竟同一个成员变量，两个地方声明。</p>
</blockquote>

<p>OK，这下我们知道了其实我们上面说的属性和实例变量基本就是一个东西了。但是我们一个属性对象YYClassPropertyInfo只是包含了get和set方法的名字以及属性名等一些基本信息。YYClassIvarInfo里面最特殊的就是@property (nonatomic, assign, readonly) ptrdiff_t offset; //&lt; Ivar’s offset这个属性了。
学过C的都知道，所有数据的访问最后都是要转化为地址的，一个char[10]数组要访问第8个数据，就要知道第发布数据的地址，offset就相当于实例变量的地址索引。offset加上首地址就得到了实例变量的地址。但是我不得不说作者把这些数据保存下来之后貌似并没有使用。。。。。。</p>

<p>Anyway，我们已经得到了如何解析的映射表，愉快的进入了下一个步骤，解析Json数据。
作者在解析前加了很多道防线，防止用户传入的数据格式错误，不是一个字典或者jsonData类型的数据，这些这里就不表了。解析代码如下：</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">yy_modelSetWithDictionary:</span><span class="p">(</span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">dic</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dic</span> <span class="o">||</span> <span class="n">dic</span> <span class="o">==</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">kCFNull</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">dic</span> <span class="nl">isKindOfClass</span><span class="p">:[</span><span class="bp">NSDictionary</span> <span class="k">class</span><span class="p">]])</span> <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
    
    <span class="n">_YYModelMeta</span> <span class="o">*</span><span class="n">modelMeta</span> <span class="o">=</span> <span class="p">[</span><span class="n">_YYModelMeta</span> <span class="nl">metaWithClass</span><span class="p">:</span><span class="n">object_getClass</span><span class="p">(</span><span class="nb">self</span><span class="p">)];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">modelMeta</span><span class="o">-&gt;</span><span class="n">_keyMappedCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="n">ModelSetContext</span> <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">context</span><span class="p">.</span><span class="n">modelMeta</span> <span class="o">=</span> <span class="p">(</span><span class="k">__bridge</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">modelMeta</span><span class="p">);</span>
    <span class="n">context</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="p">(</span><span class="k">__bridge</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="nb">self</span><span class="p">);</span>
    <span class="n">context</span><span class="p">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="p">(</span><span class="k">__bridge</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">dic</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">modelMeta</span><span class="o">-&gt;</span><span class="n">_keyMappedCount</span> <span class="o">&gt;=</span> <span class="n">CFDictionaryGetCount</span><span class="p">((</span><span class="n">CFDictionaryRef</span><span class="p">)</span><span class="n">dic</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">CFDictionaryApplyFunction</span><span class="p">((</span><span class="n">CFDictionaryRef</span><span class="p">)</span><span class="n">dic</span><span class="p">,</span> <span class="n">ModelSetWithDictionaryFunction</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">modelMeta</span><span class="o">-&gt;</span><span class="n">_keyPathPropertyMetas</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">CFArrayApplyFunction</span><span class="p">((</span><span class="n">CFArrayRef</span><span class="p">)</span><span class="n">modelMeta</span><span class="o">-&gt;</span><span class="n">_keyPathPropertyMetas</span><span class="p">,</span>
                                 <span class="n">CFRangeMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CFArrayGetCount</span><span class="p">((</span><span class="n">CFArrayRef</span><span class="p">)</span><span class="n">modelMeta</span><span class="o">-&gt;</span><span class="n">_keyPathPropertyMetas</span><span class="p">)),</span>
                                 <span class="n">ModelSetWithPropertyMetaArrayFunction</span><span class="p">,</span>
                                 <span class="o">&amp;</span><span class="n">context</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">CFArrayApplyFunction</span><span class="p">((</span><span class="n">CFArrayRef</span><span class="p">)</span><span class="n">modelMeta</span><span class="o">-&gt;</span><span class="n">_allPropertyMetas</span><span class="p">,</span>
                             <span class="n">CFRangeMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">modelMeta</span><span class="o">-&gt;</span><span class="n">_keyMappedCount</span><span class="p">),</span>
                             <span class="n">ModelSetWithPropertyMetaArrayFunction</span><span class="p">,</span>
                             <span class="o">&amp;</span><span class="n">context</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">modelMeta</span><span class="o">-&gt;</span><span class="n">_hasCustomTransformFromDictonary</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[((</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">YYModel</span><span class="o">&gt;</span><span class="p">)</span><span class="nb">self</span><span class="p">)</span> <span class="nl">modelCustomTransformFromDictionary</span><span class="p">:</span><span class="n">dic</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>很简单，如果我们的映射表中的key超过了提供的json字典中的key的个数，我们就认为有些字段是不要设置值的，所以对json字典进行遍历，反之就对映射表进行遍历。
最后如果我们有一些自定义的转化规则，在最后调用用户自己写的modelCustomTransformFromDictionary方法。至此YYModel的解析就结束了</p>

<h3 id="section-1">总结</h3>
<hr />
<p>YYModel的作者真的是一个大神，我真心佩服这样的一个90后(同为90的我惭愧不已)，他写了很多开源的第三方库，而这些第三方库都是他在这两年内通公司项目总结等归纳出来的，
其中有很多很强大的YYText等控件（解决了文字竖排的问题，也是我下一个要学习的库）也得到了很多人的关注。其中YYModel只是这位大神利用业余时间2周写出来的随笔。。。。我
花了近1一个月时间才勉强弄懂了七八分，要让我自己写那是万万不能的。一个阶段的学习计划应该是先把YYModel再重新吃一边，直到吃透了，然后花两周时间默写出来。。。
然后在学习大神的YYText库，丰富我之前写的可怜的CoreText库（相比之下我这个简直不能叫库）。。。。。</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
      <div class="entry-image-index">
        <a href="/ios/customview/coretextview/" title="CoreTextView"><img src="/images//IOS/CustomView/coreTextView.png" alt="CoreTextView"></a>
      </div><!-- /.entry-image -->
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2015-11-04T11:39:43+08:00"><a href="/ios/customview/coretextview/">November 04, 2015</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About 陆 伟">陆 伟</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
        Reading time ~3 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/ios/customview/coretextview/" rel="bookmark" title="CoreTextView" itemprop="url">CoreTextView</a></h1>
    
  </header>
  <div class="entry-content">
    <h3 id="section">如何实现一个轻量级的竖排文字显示控件</h3>
<hr />
<figure>
	<img src="/images/IOS/CustomView/releaseV1.1.png" alt="项目实例" />
	<figcaption><a href="https://github.com/luwei2012/CoreTextView">CoreTextView</a></figcaption>
</figure>
<p>感谢<a href="http://geeklu.com/2013/03/core-text/">卢克的博客和代码</a>，给了我很多帮助和启发。卢克的博客里详细介绍了如何使用Core Text来绘制富文本，而且展示了苹果如何处理字体的分解图，加上<a href="https://developer.apple.com/library/mac/documentation/StringsTextFonts/Conceptual/CoreText_Programming/LayoutOperations/LayoutOperations.html">苹果官方的demo</a>,最终我拼凑出来一个竖排显示文字的控件。</p>

<h3 id="section-1">竖排显示文字的核心思想</h3>
<hr />
<p>说起来很简单，可能大家也都看到过，其实在IOS的富文本属性中有两个不常用的属性：NSWritingDirectionAttributeName和NSVerticalGlyphFormAttributeName。
故名思议NSVerticalGlyphFormAttributeName就是控制文字竖向还是横向绘制，而NSWritingDirectionAttributeName控制的是文本绘制方向。
下面就很简单了，只需要把NSVerticalGlyphFormAttributeName设置为1(0 means horizontal text.  1 indicates vertical text.),NSWritingDirectionAttributeName设置为
@[@(NSWritingDirectionRightToLeft)]，理论上就能实现一个古文风格的竖排显示效果了。</p>

<p>于是我满心欢喜的构建了一个富文本对象，并添加了这两个属性，然后发现并没有任何卵用。首先是NSVerticalGlyphFormAttributeName只针对英文起作用，其次NSVerticalGlyphFormAttributeName并没有改变绘制的方向。
这里我需要拎清楚两个概念：我在上面说NSWritingDirectionAttributeName控制的是文本绘制方向意思是文本从左到右绘制或者从右到左，这个我称之为文本绘制方向；我说NSVerticalGlyphFormAttributeName并没有改变绘制的方向
意思是把文字渲染到屏幕的方向。</p>

<p>在我设置了NSVerticalGlyphFormAttributeName之后，文本里面的字母顺时针旋转了90°，变成了竖向显示，但是整个文本还是一行。也许有人就会想直接把控件旋转90°不就行了么，对于单行文本
这种做法确实是最简单有效地，但是需要绘制多行文本的时候，这个方法就很难控制了。你需要创建多个UILabel并设置他们的坐标、宽高等等，还需要自己切分文本，分段显示。。。听起来就觉得不可能实现。。</p>

<p>偶然的机会，我在stackoverflow上看到一个提问，贴了一段代码，居然能实现了文本行变列，他提的问题是如何能使汉字和英文字符高度整体居中对齐。这种感觉就像是我还在解决温饱问题
而人家开始像怎么找乐子了。。。于是我那段代码扒了下来仔细研究了下。最核心的部分分为两个：</p>

<h4 id="ctframerefkctframeprogressionattributename">1.创建CTFrameRef的时候需要添加一个属性kCTFrameProgressionAttributeName</h4>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="cm">/*!</span>
<span class="cm">	@const		kCTFrameProgressionAttributeName</span>
<span class="cm">	@abstract	Specifies progression for a frame.</span>
<span class="cm">	</span>
<span class="cm">	@discussion Value must be a CFNumberRef containing a CTFrameProgression.</span>
<span class="cm">				Default is kCTFrameProgressionTopToBottom. This value determines</span>
<span class="cm">				the line stacking behavior for a frame and does not affect the</span>
<span class="cm">				appearance of the glyphs within that frame.</span>

<span class="cm">	@seealso	CTFramesetterCreateFrame</span>
<span class="cm">*/</span>
<span class="n">CTFrameRef</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">CTFramesetterCreateFrame</span><span class="p">(</span><span class="n">framesetter</span><span class="p">,</span>
                                            <span class="n">CFRangeMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                            <span class="n">path</span><span class="p">,</span>
                                            <span class="p">(</span><span class="n">CFDictionaryRef</span><span class="p">)</span><span class="l">@{</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nl">kCTFrameProgressionAttributeName</span><span class="p">:</span> <span class="l">@(</span><span class="n">kCTFrameProgressionRightToLeft</span><span class="l">)}</span><span class="p">);</span></code></pre></div>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="cm">/*!</span>
<span class="cm">    @enum		CTFrameProgression</span>
<span class="cm">    @abstract	These constants specify frame progression types.</span>

<span class="cm">    @discussion The lines of text within a frame may be stacked for either</span>
<span class="cm">                horizontal or vertical text. Values are enumerated for each</span>
<span class="cm">                stacking type supported by CTFrame. Frames created with a</span>
<span class="cm">                progression type specifying vertical text will rotate lines</span>
<span class="cm">                90 degrees counterclockwise when drawing.</span>

<span class="cm">    @constant	kCTFrameProgressionTopToBottom</span>
<span class="cm">                Lines are stacked top to bottom for horizontal text.</span>

<span class="cm">    @constant	kCTFrameProgressionRightToLeft</span>
<span class="cm">                Lines are stacked right to left for vertical text.</span>

<span class="cm">    @constant	kCTFrameProgressionLeftToRight</span>
<span class="cm">                Lines are stacked left to right for vertical text.</span>
<span class="cm">*/</span>

<span class="k">typedef</span> <span class="nf">CF_ENUM</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="n">CTFrameProgression</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">kCTFrameProgressionTopToBottom</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">kCTFrameProgressionRightToLeft</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">kCTFrameProgressionLeftToRight</span>  <span class="o">=</span> <span class="mi">2</span>
<span class="p">}</span></code></pre></div>

<p>至此我们就能控制文本的行变列。</p>

<h4 id="section-2">2.让汉字保持竖向</h4>

<p>添加了kCTFrameProgressionAttributeName属性后其实就相当于把绘制区域顺时针旋转了90°，汉字躺下了。。。因此我们需要为每个汉字额外设置一些样式：</p>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="cm">/*!</span>
<span class="cm">    @const      kCTVerticalFormsAttributeName</span>
<span class="cm">    @abstract   Controls glyph orientation.</span>

<span class="cm">    @discussion Value must be a CFBooleanRef. Default is false. A value of false</span>
<span class="cm">                indicates that horizontal glyph forms are to be used, true</span>
<span class="cm">                indicates that vertical glyph forms are to be used.</span>
<span class="cm">*/</span>

<span class="k">extern</span> <span class="k">const</span> <span class="n">CFStringRef</span> <span class="n">kCTVerticalFormsAttributeName</span> <span class="nf">CT_AVAILABLE</span><span class="p">(</span><span class="mi">10</span><span class="n">_5</span><span class="p">,</span> <span class="mi">4</span><span class="n">_3</span><span class="p">);</span>
<span class="bp">NSMutableAttributedString</span> <span class="o">*</span><span class="n">attrStr</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSMutableAttributedString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithString</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">text</span> <span class="nl">attributes</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">attrStr</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="nb">self</span> <span class="nl">isChinese</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">text</span> <span class="nl">index</span><span class="p">:</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">attrStr</span> <span class="nl">addAttribute</span><span class="p">:(</span><span class="kt">id</span><span class="p">)</span><span class="n">kCTVerticalFormsAttributeName</span>
                        <span class="nl">value</span><span class="p">:</span><span class="m">@YES</span>
                        <span class="nl">range</span><span class="p">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)];</span> 
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>这两步处理完之后我们的文本就能够竖向显示了，只是字母跟汉字不会右对齐。但是到这里我们才刚开始。</p>

<h4 id="section-3">如何才能让文本居中显示？</h4>
<p>使用Core Text绘制文本主要有</p>

<h5 id="section-4">1.获取画布并设置好坐标系</h5>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="c1">//获取画布句柄</span>
<span class="n">CGContextRef</span> <span class="n">context</span> <span class="o">=</span> <span class="n">UIGraphicsGetCurrentContext</span><span class="p">();</span>
<span class="c1">//颠倒窗口 坐标计算使用的mac下的坐标系 跟ios的坐标系正好颠倒</span>
<span class="n">CGContextSetTextMatrix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">CGAffineTransformIdentity</span><span class="p">);</span>
<span class="n">CGContextTranslateCTM</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">self</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
<span class="n">CGContextScaleCTM</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">);</span></code></pre></div>

<h5 id="section-5">2.生成需要绘制的内容</h5>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="c1">//生成富文本的信息 具体不懂  反正这是core text绘制的必须流程和对象</span>
<span class="n">CTFramesetterRef</span> <span class="n">framesetter</span> <span class="o">=</span> <span class="n">CTFramesetterCreateWithAttributedString</span><span class="p">((</span><span class="k">__bridge</span> <span class="n">CFAttributedStringRef</span><span class="p">)</span><span class="nb">self</span><span class="p">.</span><span class="n">attributedText</span><span class="p">);</span></code></pre></div>

<p>这里的attributedText就是一个富文本对象，我们可以设置行间距、字间距、颜色和字体等等一系列属性。</p>

<h5 id="section-6">3.生成绘制区域</h5>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="c1">//这一步生成合适的绘制区域</span>
<span class="n">CGPathRef</span> <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">createPathWithLines</span><span class="p">];</span></code></pre></div>

<p>createPathWithLines方法我们后面要讲，最简单的实现就是把整个self.bound作为绘制区域，就跟卢克的博客里写的一样</p>

<h5 id="section-7">4.绘制</h5>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="c1">// Create a frame for this column and draw it.</span>
<span class="n">CTFrameRef</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">CTFramesetterCreateFrame</span><span class="p">(</span><span class="n">framesetter</span><span class="p">,</span>
                                            <span class="n">CFRangeMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                            <span class="n">path</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">br</span><span class="o">&gt;</span>
                                            <span class="p">(</span><span class="n">CFDictionaryRef</span><span class="p">)</span><span class="l">@{</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nl">kCTFrameProgressionAttributeName</span><span class="p">:</span> <span class="l">@(</span><span class="n">kCTFrameProgressionRightToLeft</span><span class="l">)}</span><span class="p">);</span>
<span class="n">CTFrameDraw</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span></code></pre></div>

<h5 id="section-8">5.释放内存</h5>

<div class="highlight"><pre><code class="language-logos" data-lang="logos"><span class="c1">//释放内存</span>
<span class="n">CFRelease</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
<span class="n">CFRelease</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<span class="n">CFRelease</span><span class="p">(</span><span class="n">framesetter</span><span class="p">);</span></code></pre></div>

<p>由此可见想要实现居中显示，我们只需要计算出正确的绘制区域就行了。其实不光是居中，你想要啥对齐效果都可以通过设置绘制区域来达到。
计算绘制区域的方法可以参见<a href="https://github.com/luwei2012/CoreTextView">我的代码</a>都有详细的注释。</p>

<h4 id="section-9">处理横竖屏切换</h4>
<p>这个很简单，横竖屏切换会触发layoutSubviews方法，在layoutSubviews方法里重绘即可。</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->


<div class="pagination">
  
    Previous
  
  <ul class="inline-list">
    <li>
      
        <span class="current-page">1</span>
      
    </li>
    
      <li>
        
          <a href="/page2">2</a>
        
      </li>
    
  </ul>
  
    <a href="/page2" class="btn">Next</a>
  
</div><!-- /.pagination -->
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2016 陆 伟. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>



<script type="text/javascript">
  SyntaxHighlighter.all()
</script>
          

</body>
</html>